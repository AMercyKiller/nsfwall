<!DOCTYPE html>
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>NSFWall â€“ Lite Edition (Glass Dock UI v13.1)</title>

    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">


    <style>
        /* 1. åŸºç¡€æ ·å¼å’Œä¸»é¢˜å˜é‡ - é€‚é… Glassmorphism */
        :root {
            /* æµ…è‰²æ¨¡å¼å˜é‡ */
            --bg-base: #f0f2f5; 
            --text-color: #111;
            --glass-bg: rgba(255, 255, 255, 0.2); /* æ ¸å¿ƒç»ç’ƒèƒŒæ™¯ */
            --glass-border: rgba(255, 255, 255, 0.4); /* äº®è¾¹æ¡† */
            --border-color: rgba(0, 0, 0, 0.05); /* æ·±è‰²è¾¹æ¡†ï¼ˆç”¨äºæ”¶æ•›ï¼‰ */
            --accent-color: #1a73e8; /* Google è“ */
            --shadow-color: rgba(0, 0, 0, 0.15);
            --radius-large: 20px; 
            --radius-small: 10px;
            --transition-speed: 0.3s ease;
            --dock-height: 50px; /* Dock æŒ‰é’®åŸºç¡€é«˜åº¦ */
            --src-block-size: 40px; 
            --dock-bottom-offset: 60px; /* Dock è·ç¦»åº•éƒ¨çš„è·ç¦» */
        }

        /* æ·±è‰²æ¨¡å¼è¦†ç›– */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-base: #121212;
                --text-color: #f0f0f0;
                --glass-bg: rgba(255, 255, 255, 0.05); 
                --glass-border: rgba(255, 255, 255, 0.1); 
                --border-color: rgba(255, 255, 255, 0.05);
                --shadow-color: rgba(0, 0, 0, 0.4);
            }
        }

        /* 2. å…¨å±€å’Œå¸ƒå±€æ ·å¼ */
        * {
            font-family: 'Inter', sans-serif !important; 
            font-weight: 400;
            box-sizing: border-box;
            font-style: normal;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: var(--bg-base);
            color: var(--text-color);
            overflow-x: hidden; 
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.5s ease;
        }
        
        #container {
            position: relative;
            width: 100vw;
            min-height: 100vh;
        }

        /* 3. èƒŒæ™¯å’Œä¸»å›¾ç‰‡ (ä¿ç•™åœ†è§’) */
        #bg-blur {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            filter: blur(40px) brightness(0.7);
            transform: scale(1.05);
            opacity: 0;
            z-index: 0;
            transition: opacity 0.8s ease;
            border-radius: var(--radius-large); 
        }

        #img {
            position: fixed;
            top: 0;
            left: 0;
            max-width: 100vw;
            max-height: 100vh;
            width: 100%;
            height: 100%;
            object-fit: contain;
            user-select: none;
            pointer-events: auto;
            opacity: 0;
            z-index: 1;
            transition: opacity 0.5s ease;
            display: none;
            border-radius: var(--radius-large); 
        }
        
        /* 4. ä¿¡æ¯æ¨¡å—ï¼šæ—¶é’Ÿ+å¤©æ°”+ä¸€è¨€ */
        #info-widget {
            position: fixed;
            z-index: 10;
            padding: 25px 35px;
            max-width: 450px;
            min-width: 320px;
            text-align: center;
            color: var(--text-color);
            text-shadow: 0 1px 4px var(--shadow-color);
            
            background: var(--glass-bg); 
            backdrop-filter: blur(25px) saturate(180%);
            border-radius: var(--radius-large);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 30px var(--shadow-color);
            
            cursor: move; /* å¯ç”¨æ‹–åŠ¨ */
            transform: translate(-50%, -50%); 
            top: 50%; 
            left: 50%; 
            transition: opacity var(--transition-speed), background 0.5s ease, backdrop-filter 0.5s ease;
            will-change: top, left, transform; /* ä¼˜åŒ–æ‹–åŠ¨æ€§èƒ½ */
            
            display: flex;
            flex-direction: column;
            align-items: center;

        }
        
        #info-widget[data-visible="false"] {
             display: none !important;
        }

        #clock-area {
            font-size: 4.2em;
            font-weight: 700;
            letter-spacing: -3px;
            line-height: 1;
            font-variant-numeric: tabular-nums; 
            font-feature-settings: "tnum"; 
        }
        
        #weather-area {
            width: 100%; 
            padding: 10px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #weather-display {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 1.3em; 
            font-weight: 700;
            justify-content: center;
        }

        #weather-icon {
            font-size: 1.8em; 
        }
        
        #hitokoto-area {
            text-align: center;
            font-size: 1em; 
            flex-grow: 1; 
            flex-direction: column;
            justify-content: center;
            width: 100%;
        }

        #hitokoto-content {
            font-style: italic;
            margin-bottom: 8px;
            line-height: 1.5;
            font-weight: 500;
        }

        #hitokoto-meta {
            font-size: 0.85em;
            opacity: 0.7;
        }


        /* 5. åº•éƒ¨ Dock å®¹å™¨ (æ–°å¢éšè—/æ˜¾ç¤ºçŠ¶æ€) */
        #bottom-dock-container {
            position: fixed;
            bottom: calc(var(--dock-bottom-offset) + var(--dock-height) + 10px); 
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            
            display: flex;
            align-items: center;
            gap: 15px; 
            
            padding: 10px 20px; 
            border-radius: 35px; 
            
            background: var(--glass-bg); 
            backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 40px var(--shadow-color);
            
            transition: all 0.5s ease;
        }
        
        /* Dock éšè—çŠ¶æ€ */
        #bottom-dock-container.hidden {
            transform: translateX(-50%) translateY(calc(100% + var(--dock-bottom-offset)));
            opacity: 0;
            pointer-events: none;
        }
        
        /* æŒ‰é’®åˆ†ç»„ */
        .dock-group {
            display: flex;
            gap: 10px; 
        }
        
        /* åˆ†éš”çº¿ */
        .dock-group-separator {
            width: 1px;
            height: 30px;
            background: var(--glass-border);
            opacity: 0.7;
        }
        
        /* ç»ç’ƒæŒ‰é’®åŸºå‡†æ ·å¼ (åœ†å½¢) */
        .control-button {
            all: unset;
            box-sizing: border-box;
            width: var(--dock-height); 
            height: var(--dock-height);
            border-radius: 50%;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg); 
            backdrop-filter: blur(15px);
            color: var(--text-color);
            font-size: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 15px var(--shadow-color); 
            transition: background var(--transition-speed), transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
        }

        .control-button:hover {
            background: var(--glass-border); 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px var(--shadow-color);
        }
        
        /* 6. æºé€‰æ‹© Popover (ä»¿ Dock æ‰©å±•) */
        #source-popover {
            position: fixed;
            bottom: calc(var(--dock-bottom-offset) + var(--dock-height) + 90px); 
            left: 50%;
            transform: translateX(-50%) translateY(10px); 
            z-index: 25;
            
            background: var(--glass-bg); 
            backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid var(--glass-border);
            box-shadow: 0 5px 20px var(--shadow-color);
            
            border-radius: var(--radius-large);
            padding: 15px;
            
            display: flex;
            flex-direction: column; 
            
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            min-width: 320px; 
        }
        
        #source-popover.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) translateY(0); 
        }

        .popover-header {
            font-weight: 700;
            font-size: 1.1em;
            text-align: center;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        
        #source-buttons {
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 10px; 
            padding-top: 5px;
        }

        /* æºé€‰æ‹©å— (src-block) - ä¿æŒåœ†å½¢è®¾è®¡ */
        .src-block {
            all: unset;
            box-sizing: border-box;
            text-align: center;
            width: var(--src-block-size); 
            height: var(--src-block-size);
            line-height: var(--src-block-size); 
            font-size: 14px;
            font-weight: 600;
            border-radius: 50%; 
            cursor: pointer;
            
            background: rgba(255, 255, 255, 0.1); 
            color: var(--text-color);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .src-block:hover {
            background: var(--glass-border);
            transform: scale(1.05);
        }

        .src-block.selected {
            border: 1px solid var(--glass-border);
            outline: 2px solid var(--accent-color);
            outline-offset: 1px;
            background: var(--accent-color); 
            color: #fff;
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.4);
        }


        /* 7. åŸå¸‚é€‰æ‹©å™¨ (å³ä¸‹è§’å¡ç‰‡) */
        #city-selector-container {
            position: fixed;
            right: var(--dock-bottom-offset); 
            bottom: calc(var(--dock-bottom-offset) + var(--dock-height) + 10px); 
            z-index: 50;
            width: 90%;
            max-width: 380px; 
            height: 90%;
            max-height: 500px; 
            
            background: var(--glass-bg); 
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: var(--radius-large);
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 40px var(--shadow-color);
            padding: 20px;
            
            display: none; 
            flex-direction: column;
            gap: 15px;
            
            transform: translateX(100%) translateY(0); 
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
        }
        
        #city-selector-container.visible {
            transform: translateX(0) translateY(0); 
            display: flex;
        }

        .selector-header {
            font-size: 1.2em;
            font-weight: 700;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .selector-header button {
            all: unset;
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px;
            transition: color 0.2s;
        }

        .selector-header button:hover {
            color: var(--accent-color);
        }
        
        .selector-list-wrapper {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px; 
        }
        
        .selector-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px;
            padding: 5px 0;
        }
        
        .selector-item {
            padding: 8px 10px;
            background-color: rgba(255, 255, 255, 0.1); 
            color: var(--text-color);
            border-radius: var(--radius-small);
            cursor: pointer;
            transition: background-color 0.15s, transform 0.1s;
            font-weight: 500;
            text-align: center;
            border: 1px solid var(--border-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .selector-item:hover {
             background-color: var(--glass-border);
             transform: translateY(-1px);
        }
        
        /* 8. Dock å‘¼å‡ºæŒ‰é’®æ ·å¼ */
        #dock-callout-button {
            position: fixed;
            bottom: calc(var(--dock-bottom-offset) + var(--dock-height) + 30px);
            left: 95%;
            transform: translateX(-50%);
            z-index: 15; 
            
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        #dock-callout-button.visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* 9. è®¸å¯æ¨¡æ€æ¡†æ ·å¼ */
        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #license-modal {
            background: var(--bg-base);
            color: var(--text-color);
            padding: 30px;
            border-radius: var(--radius-large);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        #modal-overlay.visible #license-modal {
            transform: scale(1);
        }

        #license-modal h2 {
            font-weight: 700;
            font-size: 1.5em;
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        #license-modal h3 {
            font-weight: 700;
            font-size: 1.2em;
            margin-top: 15px;
            color: var(--accent-color);
        }

        #license-modal p {
            font-size: 0.9em;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        #modal-accept-button {
            display: block;
            width: 80%;
            margin: 20px auto 0;
            padding: 10px 20px;
            background-color: var(--accent-color);
            color: #fff;
            border: none;
            border-radius: var(--radius-small);
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #modal-accept-button:hover {
            background-color: #1656b8;
        }


        /* ç§»åŠ¨ç«¯é€‚é… (æ›´æ–° Dock å’Œ Selector) */
        @media (max-width: 768px) {
            
            #info-widget {
                padding: 20px;
                max-width: 90vw; 
                min-width: unset;
                border-radius: var(--radius-large);
            }
            
            #clock-area {
                font-size: 3.2em;
                letter-spacing: -2px;
            }
            
            :root {
                --dock-height: 44px; 
                --src-block-size: 36px; 
                --dock-bottom-offset: 15px;
            }

            #bottom-dock-container {
                bottom: calc(var(--dock-bottom-offset) + var(--dock-height) + 10px);
                padding: 8px 15px;
                gap: 8px; 
            }
            
            .dock-group-separator {
                height: 25px;
            }
            
            .control-button {
                font-size: 18px;
            }

            #source-popover {
                bottom: calc(var(--dock-bottom-offset) + var(--dock-height) + 30px);
                max-width: 90vw;
                padding: 10px;
                min-width: unset;
            }
            
            #source-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
            
            #city-selector-container {
                right: 5vw;
                bottom: 5vw;
                top: 5vw;
                left: 5vw;
                max-width: unset;
                max-height: unset;
                height: auto;
            }
            
            .selector-list {
                grid-template-columns: repeat(2, 1fr); 
            }
        }
    </style>
</head>

<body>
    <div id="container" role="main" aria-label="æ¡Œé¢å£çº¸å±•ç¤ºåŒº">
        <img id="bg-blur" aria-hidden="true" alt="">

        <img id="img" alt="éšæœºæ¡Œé¢å£çº¸">

        <div id="progress-container" aria-hidden="true">
            <div class="spinner"></div>
            <div id="progress-text" role="alert" aria-live="assertive"></div>
        </div>

        <div id="info-widget" class="info-widget" aria-live="polite" aria-label="æ—¶é’Ÿã€å¤©æ°”å’Œä¸€è¨€" data-visible="true" style="display: flex; touch-action: none;">
            <div id="clock-area" style="display: block;">21:57:00</div> 
            
            <div id="weather-area" style="display: block;">
                <div id="weather-display">
                    <span id="weather-icon">â˜ï¸</span>
                    <span id="location-text">Ip</span>
                    <span id="temp-text">12Â°C</span>
                </div>
            </div>
            
            <div id="hitokoto-area" style="display: block;">
                <div id="hitokoto-content">å¥‡æ€ªçš„æ˜¯ï¼Œå½“ä»–æ­»å»ï¼Œæ‰€æœ‰äººæ‰å¼€å§‹çˆ±ä»–ã€‚</div>
                <div id="hitokoto-meta">â€”â€” å´”é›ªè‰ å‡ºè‡ªã€Šå“²å­¦ã€‹</div>
            </div>
        </div>

        <div id="bottom-dock-container" role="toolbar" aria-label="åŠŸèƒ½å’Œå›¾ç‰‡æºæ§åˆ¶åŒº">
            <div id="source-group" class="dock-group">
                <button id="btn-source-toggle" class="control-button" type="button" title="åˆ‡æ¢å›¾ç‰‡æº (H)">
                    <i class="icon-source">ğŸ—</i>
                </button>
            </div>
            
            <div class="dock-group-separator"></div>

            <div id="info-group" class="dock-group">
                <button id="btn-clock-toggle" class="control-button" type="button" title="éšè—æ—¶é’Ÿ">
                    <i class="icon-clock">ğŸ•ï¸</i>
                </button>
                <button id="btn-weather-toggle" class="control-button" type="button" title="éšè—å¤©æ°”">
                    <i class="icon-weather">ğŸŒ¤ï¸</i>
                </button>
                <button id="btn-hitokoto-toggle" class="control-button" type="button" title="éšè—ä¸€è¨€ (U)">
                    <i class="icon-hitokoto">Â§</i>
                </button>
            </div>

            <div class="dock-group-separator"></div>

            <div id="action-group" class="dock-group">
                <button id="btn-city-search" class="control-button" type="button" title="æœç´¢åŸå¸‚å¤©æ°”">
                    <i class="icon-search">ğŸ—º</i>
                </button>
                <button id="btn-hitokoto-refresh" class="control-button" type="button" title="åˆ·æ–°ä¸€è¨€/å¤©æ°” (Y)">
                    <i class="icon-quote">#ï¸</i>
                </button>
                <button id="btn-refresh" class="control-button" type="button" title="åˆ·æ–°å£çº¸ (R)">
                    <i class="icon-refresh">â†»</i>
                </button>
                <button id="btn-wallpaper-toggle" class="control-button" type="button" title="åˆ‡æ¢å£çº¸æ˜¾ç¤º (T)">
                    <i class="icon-wallpaper-toggle">ğŸ</i>
                </button>
            </div>
            
            <div class="dock-group-separator"></div>
            
            <div id="toggle-dock-group" class="dock-group">
                 <button id="btn-dock-toggle" class="control-button" type="button" title="æ”¶èµ· Dock æ  (K)">
                    <i class="icon-dock-toggle">â¬‡</i>
                </button>
            </div>
        </div>

        <div id="source-popover" role="dialog" aria-modal="true" aria-label="å›¾ç‰‡æºé€‰æ‹©">
            <div class="popover-header">å›¾ç‰‡æºé€‰æ‹©</div>
            <div id="source-buttons">
            </div>
        </div>

        <div id="city-selector-container" role="dialog" aria-modal="true" aria-label="åŸå¸‚é€‰æ‹©å™¨" data-step="province">
            <div class="selector-header">
                <button id="city-back-button" title="è¿”å›çœä»½é€‰æ‹©" style="display: none;">â†</button>
                <span id="selector-title" style="flex-grow: 1; text-align: center;">è¯·é€‰æ‹©çœä»½/ç›´è¾–å¸‚</span>
                <button id="city-close-button" title="å…³é—­é€‰æ‹©å™¨">âœ–</button>
            </div>
            <div class="selector-list-wrapper">
                <div id="province-list" class="selector-list"></div>
                <div id="city-list" class="selector-list" style="display: none;"></div>
            </div>
        </div>
        
        <button id="dock-callout-button" class="control-button" type="button" title="å±•å¼€ Dock æ  (K)">
            <i class="icon-dock-callout">â¬†</i>
        </button>


        <div id="toast" role="alert" aria-live="assertive" aria-atomic="true" style="opacity: 0; transform: translateY(10px);">æºé€‰æ‹©å·²æ”¶èµ·</div>

        <div id="modal-overlay">
            <div id="license-modal">
                <h2>ä½¿ç”¨è®¸å¯ã€éšç§æ¡æ¬¾å’Œç‰ˆæƒå‘Šç¤º</h2>
                <p>æ¬¢è¿ä½¿ç”¨ NSFWall Lite Edition (Glass Dock UI v13.1)ã€‚åœ¨ä½¿ç”¨æœ¬åº”ç”¨ä¹‹å‰ï¼Œè¯·ä»”ç»†é˜…è¯»ä»¥ä¸‹æ¡æ¬¾ï¼š</p>
                
                <h3>ä½¿ç”¨è®¸å¯</h3>
                <p>æœ¬åº”ç”¨ä»…ä¾›ä¸ªäººå­¦ä¹ å’Œå¨±ä¹ä½¿ç”¨ï¼Œä¸å¾—ç”¨äºä»»ä½•å•†ä¸šç”¨é€”ã€‚æ‚¨ä½¿ç”¨æœ¬åº”ç”¨çš„è¡Œä¸ºå³è¡¨ç¤ºæ‚¨åŒæ„æœ¬åº”ç”¨çš„æ‰€æœ‰åŠŸèƒ½å‡åœ¨æ‚¨æ‰€åœ¨åœ°çš„æ³•å¾‹æ³•è§„è®¸å¯èŒƒå›´å†…ã€‚</p>
                
                <h3>éšç§æ¡æ¬¾</h3>
                <p>æœ¬åº”ç”¨ä¸ä¼šæ”¶é›†æ‚¨çš„ä»»ä½•ä¸ªäººèº«ä»½ä¿¡æ¯ã€‚ä¸ºæä¾›å¤©æ°”å’Œä½ç½®æœåŠ¡ï¼Œåº”ç”¨ä¼šå°è¯•è·å–æ‚¨çš„ IP åœ°å€ï¼Œå¹¶æ ¹æ® IP åœ°å€æŸ¥è¯¢æ‚¨çš„å¤§è‡´åœ°ç†ä½ç½®ä¿¡æ¯ã€‚æ‰€æœ‰æ•°æ®å‡é€šè¿‡ç¬¬ä¸‰æ–¹å…¬å…± API è·å–ï¼Œæœ¬åº”ç”¨ä¸ä¼šå­˜å‚¨è¿™äº›ä½ç½®ä¿¡æ¯ã€‚</p>
                
                <h3>ç‰ˆæƒå‘Šç¤º</h3>
                <p><strong>âš ï¸é‡è¦æç¤ºï¼šæœ¬åº”ç”¨å†…å±•ç¤ºçš„æ‰€æœ‰å›¾ç‰‡èµ„æºå‡æ¥æºäºäº’è”ç½‘å…¬å¼€ APIï¼Œç‰ˆæƒå½’åŸä½œè€…å’ŒåŸç½‘ç«™æ‰€æœ‰ã€‚å¼€å‘è€…ä¸æ‹¥æœ‰å›¾ç‰‡çš„ä»»ä½•ç‰ˆæƒã€‚</strong></p>
                <p>å¦‚ä»»ä½•å›¾ç‰‡å†…å®¹ä¾µçŠ¯äº†æ‚¨çš„åˆæ³•æƒç›Šï¼Œè¯·ç«‹å³è”ç³»å¼€å‘è€…è¿›è¡Œåˆ é™¤ã€‚å¼€å‘è€…ä¸å¯¹ç¬¬ä¸‰æ–¹ API æä¾›çš„å›¾ç‰‡å†…å®¹æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚</p>

                <p style="color: var(--accent-color); font-weight: 600; text-align: center;">èµ„æºæ¥æºç½‘ç»œï¼Œå¦‚æœ‰ä¾µæƒä¸å¼€å‘è€…æ— å…³ã€‚</p>

                <button id="modal-accept-button">æˆ‘å·²é˜…è¯»å¹¶æ¥å—</button>
            </div>
        </div>

    </div>

    <script>
        (function () {
            // DOMå¼•ç”¨
            const bgBlur = document.getElementById('bg-blur');
            const img = document.getElementById('img');
            const progressContainer = document.getElementById('progress-container');
            const toast = document.getElementById('toast');
            
            const infoWidget = document.getElementById('info-widget');
            
            // æ–°å¢/ä¿®æ”¹å¼•ç”¨
            const bottomDockContainer = document.getElementById('bottom-dock-container');
            const sourcePopover = document.getElementById('source-popover'); 
            const sourceButtons = document.getElementById('source-buttons'); 
            const dockCalloutButton = document.getElementById('dock-callout-button'); // æ–°å¢å‘¼å‡ºæŒ‰é’®å¼•ç”¨

            const clockArea = document.getElementById('clock-area');
            const weatherArea = document.getElementById('weather-area');
            const hitokotoArea = document.getElementById('hitokoto-area');
            const locationText = document.getElementById('location-text');
            const tempText = document.getElementById('temp-text');
            const weatherIcon = document.getElementById('weather-icon');
            const hitokotoContent = document.getElementById('hitokoto-content');
            const hitokotoMeta = document.getElementById('hitokoto-meta');

            // æŒ‰é’®å¼•ç”¨ 
            const btnRefresh = document.getElementById('btn-refresh');
            const btnHitokotoRefresh = document.getElementById('btn-hitokoto-refresh');
            const btnSourceToggle = document.getElementById('btn-source-toggle');
            const btnWallpaperToggle = document.getElementById('btn-wallpaper-toggle');
            const btnClockToggle = document.getElementById('btn-clock-toggle');
            const btnWeatherToggle = document.getElementById('btn-weather-toggle');
            const btnHitokotoToggle = document.getElementById('btn-hitokoto-toggle');
            const btnCitySearch = document.getElementById('btn-city-search');
            const btnDockToggle = document.getElementById('btn-dock-toggle'); 
            
            // åŸå¸‚é€‰æ‹©å™¨ DOM å¼•ç”¨
            const citySelectorContainer = document.getElementById('city-selector-container');
            const provinceList = document.getElementById('province-list');
            const cityList = document.getElementById('city-list');
            const cityCloseButton = document.getElementById('city-close-button');
            const cityBackButton = document.getElementById('city-back-button');
            const selectorTitle = document.getElementById('selector-title');

            // æ¨¡æ€æ¡† DOM å¼•ç”¨ 
            const modalOverlay = document.getElementById('modal-overlay');
            const modalAcceptButton = document.getElementById('modal-accept-button');

            // çŠ¶æ€å˜é‡ 
            let currentSourceIndex = 0;
            let hasImageLoadedSuccessfully = false;
            let currentCity = null; 
            let cachedGeo = null;
            let cachedWeather = null;
            let currentProvince = null;
            
            // æ¨¡å—å¯è§æ€§çŠ¶æ€
            let isClockVisible = true;
            let isWeatherVisible = true;
            let isHitokotoVisible = true;
            let isSourcePopoverVisible = false;
            let isDockVisible = true; 
            
            // æ‹–åŠ¨çŠ¶æ€å˜é‡
            let isDragging = false;
            let dragOffsetX, dragOffsetY;

            // å›¾ç‰‡æºé…ç½® (ä¸å˜)
            const sources = [
                { url: 'https://www.onexiaolaji.cn/RandomPicture/api/?key=qq249663924&class=2', label: 'I', color: 'hsl(205,90%,50%)' },
                { url: 'https://www.onexiaolaji.cn/RandomPicture/api/?key=qq249663924&class=4', label: 'II', color: 'hsl(120,75%,42%)' },
                { url: 'https://api.r10086.com/æ¨±é“éšæœºå›¾ç‰‡apiæ¥å£.php?å›¾ç‰‡ç³»åˆ—=æå“ç¾å¥³å›¾ç‰‡', label: 'III', color: 'hsl(330,85%,45%)' },
                { url: 'https://api.r10086.com/æ¨±é“éšæœºå›¾ç‰‡apiæ¥å£.php?å›¾ç‰‡ç³»åˆ—=æ—¥æœ¬COSä¸­å›½COS', label: 'IV', 'color': 'hsl(40,86%,56%)' },
                { url: 'https://api.r10086.com/æ¨±é“éšæœºå›¾ç‰‡apiæ¥å£.php?å›¾ç‰‡ç³»åˆ—=å°‘å¥³å†™çœŸ5', label: 'V', color: 'hsl(280,70%,53%)' },
                { url: 'https://api.r10086.com/æ¨±é“éšæœºå›¾ç‰‡apiæ¥å£.php?å›¾ç‰‡ç³»åˆ—=å°‘å¥³å†™çœŸ6', label: 'VI', color: 'hsl(15,70%,48%)' },
                { url: 'https://api.lolimi.cn/API/meizi/api.php?type=image', label: 'VII', color: 'hsl(190,80%,55%)' },
                { url: 'https://api.lolimi.cn/API/meinv/api.php?type=image', label: 'VIII', color: 'hsl(280,70%,53%)' }
            ];
            
            // åŸå¸‚åˆ—è¡¨ (ä¸å˜)
            const CN_CITIES_FULL = {
                 "åŒ—äº¬": ["åŒ—äº¬"], "ä¸Šæµ·": ["ä¸Šæµ·"], "å¤©æ´¥": ["å¤©æ´¥"], "é‡åº†": ["é‡åº†"],
                "æ²³åŒ—": ["çŸ³å®¶åº„", "å”å±±", "ç§¦çš‡å²›", "é‚¯éƒ¸", "é‚¢å°", "ä¿å®š", "å¼ å®¶å£", "æ‰¿å¾·", "æ²§å·", "å»ŠåŠ", "è¡¡æ°´"],
                "å±±è¥¿": ["å¤ªåŸ", "å¤§åŒ", "é˜³æ³‰", "é•¿æ²»", "æ™‹åŸ", "æœ”å·", "æ™‹ä¸­", "è¿åŸ", "å¿»å·", "ä¸´æ±¾", "å•æ¢"],
                "è¾½å®": ["æ²ˆé˜³", "å¤§è¿", "éå±±", "æŠšé¡º", "æœ¬æºª", "ä¸¹ä¸œ", "é”¦å·", "è¥å£", "é˜œæ–°", "è¾½é˜³", "ç›˜é”¦", "é“å²­", "æœé˜³", "è‘«èŠ¦å²›"],
                "å‰æ—": ["é•¿æ˜¥", "å‰æ—", "å››å¹³", "è¾½æº", "é€šåŒ–", "ç™½å±±", "æ¾åŸ", "ç™½åŸ", "å»¶è¾¹"],
                "é»‘é¾™æ±Ÿ": ["å“ˆå°”æ»¨", "é½é½å“ˆå°”", "é¸¡è¥¿", "é¹¤å²—", "åŒé¸­å±±", "å¤§åº†", "ä¼Šæ˜¥", "ä½³æœ¨æ–¯", "ä¸ƒå°æ²³", "ç‰¡ä¸¹æ±Ÿ", "é»‘æ²³", "ç»¥åŒ–", "å¤§å…´å®‰å²­"],
                "æ±Ÿè‹": ["å—äº¬", "æ— é”¡", "å¾å·", "å¸¸å·", "è‹å·", "å—é€š", "è¿äº‘æ¸¯", "æ·®å®‰", "ç›åŸ", "æ‰¬å·", "é•‡æ±Ÿ", "æ³°å·", "å®¿è¿"],
                "æµ™æ±Ÿ": ["æ­å·", "å®æ³¢", "æ¸©å·", "å˜‰å…´", "æ¹–å·", "ç»å…´", "é‡‘å", "è¡¢å·", "èˆŸå±±", "å°å·", "ä¸½æ°´"],
                "å®‰å¾½": ["åˆè‚¥", "èŠœæ¹–", "èšŒåŸ ", "æ·®å—", "é©¬éå±±", "æ·®åŒ—", "é“œé™µ", "å®‰åº†", "é»„å±±", "æ»å·", "é˜œé˜³", "å®¿å·", "å…­å®‰", "äº³å·", "æ± å·", "å®£åŸ"],
                "ç¦å»º": ["ç¦å·", "å¦é—¨", "è†ç”°", "ä¸‰æ˜", "æ³‰å·", "æ¼³å·", "å—å¹³", "é¾™å²©", "å®å¾·"],
                "æ±Ÿè¥¿": ["å—æ˜Œ", "æ™¯å¾·é•‡", "èä¹¡", "ä¹æ±Ÿ", "æ–°ä½™", "é¹°æ½­", "èµ£å·", "å‰å®‰", "å®œæ˜¥", "æŠšå·", "ä¸Šé¥¶"],
                "å±±ä¸œ": ["æµå—", "é’å²›", "æ·„åš", "æ£åº„", "ä¸œè¥", "çƒŸå°", "æ½åŠ", "æµå®", "æ³°å®‰", "å¨æµ·", "æ—¥ç…§", "ä¸´æ²‚", "å¾·å·", "èŠåŸ", "æ»¨å·", "èæ³½"],
                "æ²³å—": ["éƒ‘å·", "å¼€å°", "æ´›é˜³", "å¹³é¡¶å±±", "å®‰é˜³", "é¹¤å£", "æ–°ä¹¡", "ç„¦ä½œ", "æ¿®é˜³", "è®¸æ˜Œ", "æ¼¯æ²³", "ä¸‰é—¨å³¡", "å—é˜³", "å•†ä¸˜", "ä¿¡é˜³", "å‘¨å£", "é©»é©¬åº—"],
                "æ¹–åŒ—": ["æ­¦æ±‰", "é»„çŸ³", "åå °", "å®œæ˜Œ", "è¥„é˜³", "é„‚å·", "è†é—¨", "å­æ„Ÿ", "è†å·", "é»„å†ˆ", "å’¸å®", "éšå·", "æ©æ–½", "ä»™æ¡ƒ", "æ½œæ±Ÿ", "å¤©é—¨", "ç¥å†œæ¶"],
                "æ¹–å—": ["é•¿æ²™", "æ ªæ´²", "æ¹˜æ½­", "è¡¡é˜³", "é‚µé˜³", "å²³é˜³", "å¸¸å¾·", "å¼ å®¶ç•Œ", "ç›Šé˜³", "éƒ´å·", "æ°¸å·", "æ€€åŒ–", "å¨„åº•", "æ¹˜è¥¿"],
                "å¹¿ä¸œ": ["å¹¿å·", "éŸ¶å…³", "æ·±åœ³", "ç æµ·", "æ±•å¤´", "ä½›å±±", "æ±Ÿé—¨", "æ¹›æ±Ÿ", "èŒ‚å", "è‚‡åº†", "æƒ å·", "æ¢…å·", "æ±•å°¾", "æ²³æº", "é˜³æ±Ÿ", "æ¸…è¿œ", "ä¸œè", "ä¸­å±±", "æ½®å·", "æ­é˜³", "äº‘æµ®"],
                "æµ·å—": ["æµ·å£", "ä¸‰äºš", "ä¸‰æ²™", "å„‹å·", "äº”æŒ‡å±±", "ç¼æµ·", "æ–‡æ˜Œ", "ä¸‡å®", "ä¸œæ–¹"],
                "å››å·": ["æˆéƒ½", "è‡ªè´¡", "æ”€æèŠ±", "æ³¸å·", "å¾·é˜³", "ç»µé˜³", "å¹¿å…ƒ", "é‚å®", "å†…æ±Ÿ", "ä¹å±±", "å—å……", "çœ‰å±±", "å®œå®¾", "å¹¿å®‰", "è¾¾å·", "é›…å®‰", "å·´ä¸­", "èµ„é˜³", "é˜¿å", "ç”˜å­œ", "å‡‰å±±"],
                "è´µå·": ["è´µé˜³", "å…­ç›˜æ°´", "éµä¹‰", "å®‰é¡º", "æ¯•èŠ‚", "é“œä»", "é»”è¥¿å—", "é»”ä¸œå—", "é»”å—"],
                "äº‘å—": ["æ˜†æ˜", "æ›²é–", "ç‰æºª", "ä¿å±±", "æ˜­é€š", "ä¸½æ±Ÿ", "æ™®æ´±", "ä¸´æ²§", "æ¥šé›„", "çº¢æ²³", "æ–‡å±±", "è¥¿åŒç‰ˆçº³", "å¤§ç†", "å¾·å®", "æ€’æ±Ÿ", "è¿ªåº†"],
                "é™•è¥¿": ["è¥¿å®‰", "é“œå·", "å®é¸¡", "å’¸é˜³", "æ¸­å—", "å»¶å®‰", "æ±‰ä¸­", "æ¦†æ—", "å®‰åº·", "å•†æ´›"],
                "ç”˜è‚ƒ": ["å…°å·", "å˜‰å³ªå…³", "é‡‘æ˜Œ", "ç™½é“¶", "å¤©æ°´", "æ­¦å¨", "å¼ æ–", "å¹³å‡‰", "é…’æ³‰", "åº†é˜³", "å®šè¥¿", "é™‡å—", "ä¸´å¤", "ç”˜å—"],
                "é’æµ·": ["è¥¿å®", "æµ·ä¸œ", "æµ·åŒ—", "é»„å—", "æµ·å—", "æœæ´›", "ç‰æ ‘", "æµ·è¥¿"],
                "å®å¤": ["é“¶å·", "çŸ³å˜´å±±", "å´å¿ ", "å›ºåŸ", "ä¸­å«"],
                "æ–°ç–†": ["ä¹Œé²æœ¨é½", "å…‹æ‹‰ç›ä¾", "åé²ç•ª", "å“ˆå¯†", "æ˜Œå‰", "åšå°”å¡”æ‹‰", "å·´éŸ³éƒ­æ¥", "é˜¿å…‹è‹", "å…‹å­œå‹’è‹", "å–€ä»€", "å’Œç”°", "ä¼ŠçŠ", "å¡”åŸ", "é˜¿å‹’æ³°"],
                "å†…è’™å¤": ["å‘¼å’Œæµ©ç‰¹", "åŒ…å¤´", "ä¹Œæµ·", "èµ¤å³°", "é€šè¾½", "é„‚å°”å¤šæ–¯", "å‘¼ä¼¦è´å°”", "å·´å½¦æ·–å°”", "ä¹Œå…°å¯Ÿå¸ƒ", "å…´å®‰", "é”¡æ—éƒ­å‹’", "é˜¿æ‹‰å–„"],
                "è¥¿è—": ["æ‹‰è¨", "æ—¥å–€åˆ™", "æ˜Œéƒ½", "æ—èŠ", "å±±å—", "é‚£æ›²", "é˜¿é‡Œ"],
                "å¹¿è¥¿": ["å—å®", "æŸ³å·", "æ¡‚æ—", "æ¢§å·", "åŒ—æµ·", "é˜²åŸæ¸¯", "é’¦å·", "è´µæ¸¯", "ç‰æ—", "ç™¾è‰²", "è´ºå·", "æ²³æ± ", "æ¥å®¾", "å´‡å·¦"],
                "é¦™æ¸¯": ["é¦™æ¸¯"], "æ¾³é—¨": ["æ¾³é—¨"], "å°æ¹¾": ["å°åŒ—", "é«˜é›„", "å°ä¸­", "å°å—", "æ¡ƒå›­", "æ–°åŒ—", "åŸºéš†", "æ–°ç«¹", "å˜‰ä¹‰"]
            };

            let toastTimeout = null;
            function showToast(msg) { 
                toast.textContent = msg;
                toast.style.opacity = '1';
                const isMobile = window.matchMedia("(max-width: 768px)").matches;
                if (isMobile) {
                    toast.style.right = '50%';
                    toast.style.transform = 'translateX(50%) translateY(0)';
                } else {
                    toast.style.right = '30px';
                    toast.style.transform = 'translateY(0)';
                }

                if (toastTimeout) clearTimeout(toastTimeout);
                toastTimeout = setTimeout(() => {
                    toast.style.opacity = '0';
                    if (isMobile) {
                         toast.style.transform = 'translateX(50%) translateY(10px)';
                    } else {
                        toast.style.transform = 'translateY(10px)';
                    }
                }, 2000);
            }

            function updateInfoWidgetVisibility() {
                const shouldHide = !isClockVisible && !isWeatherVisible && !isHitokotoVisible;
                infoWidget.setAttribute('data-visible', !shouldHide);
            }

            function toggleModule(moduleElement, button, name, stateKey) { 
                const isVisible = moduleElement.style.display !== 'none';
                
                moduleElement.style.display = isVisible ? 'none' : 'block';
                
                button.style.opacity = isVisible ? '0.5' : '1';
                button.title = (isVisible ? 'æ˜¾ç¤º' : 'éšè—') + name;
                showToast(name + (isVisible ? ' å·²éšè—' : ' å·²æ˜¾ç¤º'));
                
                if (stateKey === 'clock') {
                    isClockVisible = !isVisible;
                } else if (stateKey === 'weather') {
                    isWeatherVisible = !isVisible;
                } else if (stateKey === 'hitokoto') {
                    isHitokotoVisible = !isVisible;
                }
                
                updateInfoWidgetVisibility();
            }

            // åŠŸèƒ½ 1: Dock æ çš„åˆ‡æ¢é€»è¾‘ (æ–°å¢å‘¼å‡ºæŒ‰é’®æ§åˆ¶)
            function toggleDock() {
                isDockVisible = !isDockVisible;

                if (isDockVisible) {
                    bottomDockContainer.classList.remove('hidden');
                    btnDockToggle.querySelector('i').textContent = 'â¬‡'; // å‘ä¸‹ç®­å¤´è¡¨ç¤ºæ”¶èµ·
                    btnDockToggle.title = 'æ”¶èµ· Dock æ  (K)';
                    dockCalloutButton.classList.remove('visible'); // éšè—å‘¼å‡ºæŒ‰é’®
                    showToast('Dock æ å·²å±•å¼€');
                } else {
                    bottomDockContainer.classList.add('hidden');
                    btnDockToggle.querySelector('i').textContent = 'â¬†'; // å‘ä¸Šç®­å¤´è¡¨ç¤ºå±•å¼€
                    btnDockToggle.title = 'å±•å¼€ Dock æ  (K)';
                    
                    // å¦‚æœ Dock éšè—ï¼ŒåŒæ—¶éšè— Popover
                    if(isSourcePopoverVisible) {
                         toggleSourcePopover();
                    }
                    
                    dockCalloutButton.classList.add('visible'); // æ˜¾ç¤ºå‘¼å‡ºæŒ‰é’®
                    showToast('Dock æ å·²æ”¶èµ·');
                }
            }


            // æºé€‰æ‹© Popover åˆ‡æ¢é€»è¾‘ (ä¿æŒä¸å˜)
            function toggleSourcePopover() {
                // å¦‚æœ Dock éšè—ï¼Œä¸å…è®¸å±•å¼€ Popover
                if (!isDockVisible && !isSourcePopoverVisible) {
                    showToast('è¯·å…ˆå±•å¼€ Dock æ ');
                    return;
                }
                
                isSourcePopoverVisible = !isSourcePopoverVisible;

                if (isSourcePopoverVisible) {
                    sourcePopover.classList.add('visible');
                    btnSourceToggle.querySelector('i').textContent = 'âœ–'; // åˆ‡æ¢æŒ‰é’®å›¾æ ‡
                    document.addEventListener('click', closeSourcePopoverOnClickOutside);
                    document.addEventListener('keydown', closeSourcePopoverOnEscape);
                } else {
                    sourcePopover.classList.remove('visible');
                    btnSourceToggle.querySelector('i').textContent = 'ğŸŒ';
                    document.removeEventListener('click', closeSourcePopoverOnClickOutside);
                    document.removeEventListener('keydown', closeSourcePopoverOnEscape);
                }
            }

            function closeSourcePopoverOnClickOutside(e) {
                 if (isSourcePopoverVisible && !sourcePopover.contains(e.target) && !btnSourceToggle.contains(e.target)) {
                    toggleSourcePopover();
                    showToast('æºé€‰æ‹©å·²æ”¶èµ·');
                }
            }

            function closeSourcePopoverOnEscape(e) {
                if (isSourcePopoverVisible && e.key === 'Escape') {
                    toggleSourcePopover();
                    showToast('æºé€‰æ‹©å·²æ”¶èµ·');
                }
            }


            // åŸå¸‚é€‰æ‹©å™¨é€»è¾‘ (ä¿æŒä¸å˜)
            function loadProvinces() {
                citySelectorContainer.classList.add('visible');
                citySelectorContainer.setAttribute('data-step', 'province');
                selectorTitle.textContent = 'è¯·é€‰æ‹©çœä»½/ç›´è¾–å¸‚';
                provinceList.style.display = 'grid';
                cityList.style.display = 'none';
                cityBackButton.style.display = 'none';
                provinceList.innerHTML = '';
                
                Object.keys(CN_CITIES_FULL).forEach(province => {
                    const item = document.createElement('div');
                    item.className = 'selector-item';
                    item.textContent = province;
                    item.addEventListener('click', () => loadCities(province));
                    provinceList.appendChild(item);
                });
            }

            function loadCities(province) {
                currentProvince = province;
                citySelectorContainer.setAttribute('data-step', 'city');
                selectorTitle.textContent = `${province} - è¯·é€‰æ‹©åŸå¸‚`;
                provinceList.style.display = 'none';
                cityList.style.display = 'grid';
                cityBackButton.style.display = 'block';
                cityList.innerHTML = '';

                const cities = CN_CITIES_FULL[province] || [];
                cities.forEach(city => {
                    const item = document.createElement('div');
                    item.className = 'selector-item';
                    item.textContent = city;
                    item.addEventListener('click', () => selectCity(city));
                    cityList.appendChild(item);
                });
            }

            function selectCity(city) {
                citySelectorContainer.classList.remove('visible');
                showToast(`æ­£åœ¨æŸ¥è¯¢ ${city} çš„å¤©æ°”...`);
                fetchWeather(city); 
            }
            
            function handleCitySearchClick() {
                if (citySelectorContainer.classList.contains('visible')) {
                    citySelectorContainer.classList.remove('visible');
                } else {
                    loadProvinces();
                }
            }

            cityCloseButton.addEventListener('click', () => {
                citySelectorContainer.classList.remove('visible');
                showToast('åŸå¸‚é€‰æ‹©å·²å–æ¶ˆ');
            });
            
            cityBackButton.addEventListener('click', () => {
                loadProvinces();
                currentProvince = null;
            });


            // å…¶ä»–è¾…åŠ©å‡½æ•°å’Œåˆå§‹åŒ–é€»è¾‘ (ä¿æŒä¸å˜)
            function updateClock() { 
                const now = new Date();
                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                const s = String(now.getSeconds()).padStart(2, '0');
                clockArea.textContent = `${h}:${m}:${s}`;
            }

            async function fetchIpLocation() { /* ... IP å®šä½é€»è¾‘ä¸å˜ ... */
                locationText.textContent = 'å®šä½ä¸­...';
                try {
                    const ipResponse = await fetch('https://api.ipify.org?format=json');
                    const ipData = await ipResponse.json();
                    const userIp = ipData.ip;
                    const geoResponse = await fetch(`https://ip-api.com/json/${userIp}?lang=zh-CN`);
                    if (!geoResponse.ok) throw new Error('Failed to fetch IP geo');
                    
                    const geoData = await geoResponse.json();
                    if (geoData.status === 'success' && geoData.city) {
                        const cityName = geoData.city;
                        const geo = await getGeoLocation(cityName);
                        if (geo) {
                            cachedGeo = geo;
                            currentCity = cityName;
                            return cityName;
                        }
                    }
                } catch (error) {
                    console.error('è·å– IP ä½ç½®å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨é»˜è®¤ IP å®šä½:', error);
                }

                try {
                    const response = await fetch('https://geocoding-api.open-meteo.com/v1/search?name=ip&count=1&language=zh&format=json');
                    if (!response.ok) throw new Error('Failed to fetch Open-Meteo IP geo');
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                        const geo = data.results[0];
                        const locationName = geo.name || geo.country || 'æœªçŸ¥ä½ç½®';
                        cachedGeo = { lat: geo.latitude, lon: geo.longitude, name: locationName };
                        currentCity = locationName;
                        return locationName;
                    }
                } catch (error) {
                    console.error('è·å– Open-Meteo IP åœ°ç†ä½ç½®å¤±è´¥:', error);
                }

                return null;
            }


            async function getGeoLocation(cityName = null) { 
                locationText.textContent = 'å®šä½ä¸­...';
                
                if (cityName) {
                    try {
                        const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityName)}&count=1&language=zh&format=json`);
                        if (!response.ok) throw new Error('Failed to fetch city geo');
                        const data = await response.json();
                        if (data.results && data.results.length > 0) {
                            const geo = data.results[0];
                            return { lat: geo.latitude, lon: geo.longitude, name: geo.name || cityName }; 
                        } else {
                            throw new Error('City not found');
                        }
                    } catch (error) {
                        console.error('é€šè¿‡åŸå¸‚åè·å–åœ°ç†ä½ç½®å¤±è´¥:', error);
                        return null; 
                    }
                }
                
                return null;
            }

            async function fetchWeather(cityName = null) { 
                 if (!cityName && cachedWeather && !currentCity) return;
                
                if (cityName) {
                    currentCity = cityName;
                    cachedGeo = null; 
                } else if (!currentCity) {
                    const ipCity = await fetchIpLocation();
                    if (ipCity) {
                        cityName = ipCity;
                        currentCity = ipCity;
                    } else {
                        locationText.textContent = 'ä½ç½®æœªçŸ¥';
                        tempText.textContent = 'N/A';
                        weatherIcon.textContent = 'âš ï¸';
                        showToast('æ— æ³•è·å–ä½ç½®ä¿¡æ¯');
                        return;
                    }
                }
                
                locationText.textContent = currentCity ? `${currentCity}...` : 'å®šä½ä¸­...';
                tempText.textContent = '--Â°C';
                weatherIcon.textContent = '...';

                const geo = cachedGeo || await getGeoLocation(currentCity);

                if (!geo || (geo.lat === 0 && geo.lon === 0 && geo.name === 'ä½ç½®æœªçŸ¥')) {
                    if (currentCity) currentCity = null; 
                    return;
                }
                
                locationText.textContent = geo.name;

                try {
                    const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${geo.lat}&longitude=${geo.lon}&current=temperature_2m,weather_code&timezone=auto&forecast_days=1`;
                    const response = await fetch(weatherUrl);
                    if (!response.ok) throw new Error('Failed to fetch weather');
                    const data = await response.json();
                    
                    const temp = Math.round(data.current.temperature_2m);
                    const code = data.current.weather_code;
                    const weatherStatus = getWeatherEmoji(code);

                    tempText.textContent = `${temp}Â°C`;
                    weatherIcon.textContent = weatherStatus;
                    cachedWeather = { temp, code, status: weatherStatus };
                    showToast(`${geo.name} å¤©æ°”: ${weatherStatus} ${temp}Â°C`);

                } catch (error) {
                    console.error('è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥:', error);
                    tempText.textContent = 'N/A';
                    weatherIcon.textContent = 'âš ï¸';
                    showToast('è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥');
                }
            }

            function getWeatherEmoji(code) { 
                if (code >= 0 && code <= 1) return 'â˜€ï¸'; 
                if (code >= 2 && code <= 3) return 'â˜ï¸'; 
                if (code >= 45 && code <= 48) return 'ğŸŒ«ï¸'; 
                if (code >= 51 && code <= 55) return 'ğŸŒ§ï¸'; 
                if (code >= 61 && code <= 65) return 'ğŸŒ§ï¸'; 
                if (code >= 71 && code <= 75) return 'ğŸŒ¨ï¸'; 
                if (code >= 80 && code <= 82) return 'â›ˆï¸'; 
                if (code >= 85 && code <= 86) return 'â„ï¸'; 
                if (code === 95) return 'â›ˆï¸'; 
                return 'â“';
            }

            function initSourceBlocks() { 
                 sourceButtons.innerHTML = '';
                sources.forEach(({ label, color }, i) => {
                    const block = document.createElement('div');
                    block.className = 'src-block';
                    block.setAttribute('role', 'button');
                    block.setAttribute('tabindex', '0');
                    block.setAttribute('aria-label', 'å›¾ç‰‡æº ' + label);
                    block.textContent = label;
                    block.dataset.index = i;

                    block.addEventListener('click', () => {
                        if (currentSourceIndex !== i) {
                            currentSourceIndex = i;
                            updateSelectedBlock();
                            toggleSourcePopover(); 
                            refreshImage();
                        } else {
                            // å†æ¬¡ç‚¹å‡»å·²é€‰ä¸­çš„æºï¼Œä¹Ÿè§¦å‘åˆ·æ–°
                             refreshImage();
                        }
                    });
                    sourceButtons.appendChild(block);
                });
                updateSelectedBlock();
            }

            function updateSelectedBlock() { 
                 sourceButtons.querySelectorAll('.src-block').forEach((block, i) => {
                    block.classList.toggle('selected', i === currentSourceIndex);
                });
            }

            async function refreshImage() { 
                let url = sources[currentSourceIndex].url;
                let fullUrl = url + (url.includes('?') ? '&' : '?') + '_ts=' + Date.now();

                progressContainer.style.display = 'flex';
                img.style.opacity = '0';
                img.style.display = 'block';
                bgBlur.style.display = 'block';
                
                // é¦–æ¬¡åŠ è½½å‰ï¼Œå°†å£çº¸æŒ‰é’®æ˜¾ç¤ºä¸ºæœªåŠ è½½çŠ¶æ€ï¼ˆé¿å…è¯¯æ“ä½œï¼‰
                btnWallpaperToggle.querySelector('i').textContent = 'Ã—'; 

                const imageLoader = new Image();
                imageLoader.onload = async () => {
                    img.src = fullUrl;
                    bgBlur.src = fullUrl;
                    
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        img.style.opacity = '1';
                        bgBlur.style.opacity = '0.3';
                        hasImageLoadedSuccessfully = true;
                        btnWallpaperToggle.querySelector('i').textContent = 'Ã—'; // æˆåŠŸåŠ è½½åæ˜¾ç¤ºÃ—
                        showToast(`å£çº¸åŠ è½½æˆåŠŸ, æº: ${sources[currentSourceIndex].label}`);
                    }, 100);
                };

                imageLoader.onerror = () => {
                    progressContainer.style.display = 'none';
                    img.style.display = 'none';
                    bgBlur.style.opacity = '0';
                    setTimeout(() => bgBlur.style.display = 'none', 300);
                    hasImageLoadedSuccessfully = false;
                    btnWallpaperToggle.querySelector('i').textContent = 'Ã—'; // åŠ è½½å¤±è´¥ï¼Œä¿æŒé»˜è®¤å›¾æ ‡
                    showToast('å£çº¸åŠ è½½å¤±è´¥');
                };

                imageLoader.src = fullUrl;
            }

            async function fetchHitokoto() { 
                hitokotoContent.textContent = 'æ­£åœ¨åŠ è½½...';
                hitokotoMeta.textContent = '';
                try {
                    const r = await fetch('https://v1.hitokoto.cn/');
                    const data = await r.json();
                    hitokotoContent.textContent = data.hitokoto;
                    hitokotoMeta.textContent = `â€”â€” ${data.from_who || 'ä½šå'} å‡ºè‡ªã€Š${data.from}ã€‹`;
                } catch {
                    hitokotoContent.textContent = 'è·å–ä¸€è¨€å¤±è´¥ã€‚';
                    hitokotoMeta.textContent = '';
                }
            }
            
            // åŠŸèƒ½ 2: åˆ‡æ¢å£çº¸é€»è¾‘ (æ›´æ–°å›¾æ ‡)
            function toggleWallpaper() { 
                if (!hasImageLoadedSuccessfully) {
                    showToast('è¯·å…ˆé€‰æ‹©æºå¹¶åŠ è½½å£çº¸ (R)');
                    return;
                }

                const isVisible = img.style.opacity === '1';

                if (isVisible) {
                    img.style.opacity = '0';
                    btnWallpaperToggle.querySelector('i').textContent = 'Ã—'; // ä½¿ç”¨ç©ºæ–¹å—è¡¨ç¤ºéšè—
                    btnWallpaperToggle.title = 'æ˜¾ç¤ºå£çº¸ (T)';
                    showToast('å£çº¸å·²éšè—');
                } else {
                    img.style.opacity = '1';
                    btnWallpaperToggle.querySelector('i').textContent = 'Ã—';
                    btnWallpaperToggle.title = 'éšè—å£çº¸ (T)';
                    showToast('å£çº¸å·²æ˜¾ç¤º');
                }
            }
            
            // è®¸å¯æ¨¡æ€æ¡†é€»è¾‘
            function showLicenseModal() {
                 if (localStorage.getItem('nsfwall_license_accepted') !== 'true') {
                    modalOverlay.classList.add('visible');
                    document.body.style.overflow = 'hidden'; 

                    modalAcceptButton.addEventListener('click', () => {
                        localStorage.setItem('nsfwall_license_accepted', 'true');
                        modalOverlay.classList.remove('visible');
                        document.body.style.overflow = ''; 
                        // æ¥å—åæ‰§è¡Œçš„åˆå§‹åŒ–æ“ä½œ
                        fetchHitokoto();
                        fetchWeather(); 
                        updateInfoWidgetVisibility(); 
                        // é¦–æ¬¡å¯åŠ¨ä¸å†é»˜è®¤è°ƒç”¨ refreshImage()
                    });
                 } else {
                    // å¦‚æœå·²æ¥å—ï¼Œç›´æ¥è¿›è¡Œåˆå§‹åŒ–
                    fetchHitokoto();
                    fetchWeather(); 
                    updateInfoWidgetVisibility(); 
                 }
            }
            
            // ===================================
            // æ–°å¢åŠŸèƒ½ï¼šInfo-Widget æ‹–åŠ¨
            // ===================================
            function startDragging(e) {
                // ç¡®ä¿åªæœ‰åœ¨ info-widget ä¸ŠæŒ‰ä¸‹é¼ æ ‡å·¦é”®æ—¶æ‰å¼€å§‹æ‹–åŠ¨
                if (e.button !== 0) return; 

                isDragging = true;
                // è®¡ç®—é¼ æ ‡ç‚¹å‡»ä½ç½®ç›¸å¯¹äº widget å·¦ä¸Šè§’çš„åç§»é‡
                const rect = infoWidget.getBoundingClientRect();
                dragOffsetX = e.clientX - rect.left;
                dragOffsetY = e.clientY - rect.top;

                // ç§»é™¤åŸæœ‰çš„ CSS transform å±æ€§ï¼Œåˆ‡æ¢åˆ° top/left å®šä½
                // å¿…é¡»ç§»é™¤ transform: translate(-50%, -50%)
                infoWidget.style.transition = 'none'; // æ‹–åŠ¨æ—¶ç¦ç”¨ CSS è¿‡æ¸¡
                infoWidget.style.position = 'fixed';
                infoWidget.style.top = rect.top + 'px';
                infoWidget.style.left = rect.left + 'px';
                infoWidget.style.transform = 'none'; 

                document.addEventListener('mousemove', dragWidget);
                document.addEventListener('mouseup', stopDragging);
            }

            function dragWidget(e) {
                if (!isDragging) return;

                // è®¡ç®—æ–°çš„ä½ç½®
                let newX = e.clientX - dragOffsetX;
                let newY = e.clientY - dragOffsetY;

                // è¾¹ç•Œé™åˆ¶
                const rect = infoWidget.getBoundingClientRect();
                
                // é™åˆ¶åœ¨å±å¹•èŒƒå›´å†…
                newX = Math.max(0, newX);
                newX = Math.min(window.innerWidth - rect.width, newX);
                newY = Math.max(0, newY);
                newY = Math.min(window.innerHeight - rect.height, newY);


                // åº”ç”¨æ–°ä½ç½®
                infoWidget.style.left = newX + 'px';
                infoWidget.style.top = newY + 'px';
            }

            function stopDragging() {
                if (!isDragging) return;
                isDragging = false;
                infoWidget.style.transition = 'opacity var(--transition-speed), background 0.5s ease, backdrop-filter 0.5s ease'; // æ¢å¤è¿‡æ¸¡æ•ˆæœ
                document.removeEventListener('mousemove', dragWidget);
                document.removeEventListener('mouseup', stopDragging);
            }


            // 6. åˆå§‹åŒ–å’Œäº‹ä»¶ç»‘å®š
            window.addEventListener('DOMContentLoaded', () => {
                
                showLicenseModal(); // é¦–æ¬¡åŠ è½½æ—¶å¤„ç†è®¸å¯æ¨¡æ€æ¡†
                
                initSourceBlocks();
                
                updateClock();
                setInterval(updateClock, 1000);
                
                // æ‹–åŠ¨äº‹ä»¶ç»‘å®š
                infoWidget.addEventListener('mousedown', startDragging);
                // é˜»æ­¢æ‹–åŠ¨æ—¶æ–‡æœ¬é€‰ä¸­
                infoWidget.addEventListener('dragstart', e => e.preventDefault());


                // ç»‘å®šäº‹ä»¶
                btnRefresh.addEventListener('click', () => { 
                    if (!hasImageLoadedSuccessfully) {
                        showToast('è¯·å…ˆé€‰æ‹©å›¾ç‰‡æº');
                        return;
                    }
                    refreshImage(); 
                    showToast('åˆ·æ–°å£çº¸'); 
                });
                
                btnHitokotoRefresh.addEventListener('click', () => { 
                    fetchHitokoto(); 
                    fetchWeather(currentCity); 
                });
                
                btnSourceToggle.addEventListener('click', () => { 
                    toggleSourcePopover();
                    if(isSourcePopoverVisible) showToast('æºé€‰æ‹©å·²å±•å¼€');
                }); 
                
                btnWallpaperToggle.addEventListener('click', toggleWallpaper);
                
                // Dock åˆ‡æ¢äº‹ä»¶
                btnDockToggle.addEventListener('click', toggleDock);
                // å‘¼å‡ºæŒ‰é’®äº‹ä»¶
                dockCalloutButton.addEventListener('click', toggleDock);

                // ç‹¬ç«‹å†…å®¹åˆ‡æ¢äº‹ä»¶
                btnClockToggle.addEventListener('click', () => toggleModule(clockArea, btnClockToggle, 'æ—¶é’Ÿ', 'clock'));
                btnWeatherToggle.addEventListener('click', () => toggleModule(weatherArea, btnWeatherToggle, 'å¤©æ°”', 'weather'));
                btnHitokotoToggle.addEventListener('click', () => toggleModule(hitokotoArea, btnHitokotoToggle, 'ä¸€è¨€', 'hitokoto'));

                // æœç´¢åŸå¸‚æŒ‰é’®äº‹ä»¶
                btnCitySearch.addEventListener('click', handleCitySearchClick);

                // å¿«æ·é”®ç»‘å®š 
                window.addEventListener('keydown', e => {
                    // å¼¹çª—å¼€å¯æˆ–è¾“å…¥æ³•åˆæˆæ—¶ç¦ç”¨å¿«æ·é”®
                    if (e.isComposing || citySelectorContainer.classList.contains('visible') || modalOverlay.classList.contains('visible')) return; 

                    switch (e.key.toLowerCase()) {
                        case 'r':
                            e.preventDefault();
                            btnRefresh.click();
                            break;
                        case 'y':
                            e.preventDefault();
                            btnHitokotoRefresh.click();
                            break;
                        case 'u':
                            e.preventDefault();
                            btnHitokotoToggle.click();
                            break;
                        case 'h':
                            e.preventDefault();
                            btnSourceToggle.click();
                            break;
                        case 't':
                            e.preventDefault();
                            toggleWallpaper();
                            break;
                        case 'k':
                            e.preventDefault();
                            toggleDock(); // K é”®ç”¨äº Dock çš„å±•å¼€/æ”¶èµ·
                            break; 
                        case 'escape':
                            e.preventDefault();
                            if (isSourcePopoverVisible) {
                                toggleSourcePopover(); 
                            } else if (citySelectorContainer.classList.contains('visible')) {
                                citySelectorContainer.classList.remove('visible');
                                showToast('åŸå¸‚é€‰æ‹©å·²å–æ¶ˆ');
                            }
                            break;
                    }
                });
            });

        })();
    </script>
</body>
</html>
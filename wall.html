<!DOCTYPE html>
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>NSFWall – Lite Edition (New UI v11.0)</title>

    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">

    <style>
        /* 1. 基础样式和主题变量 */
        :root {
            /* 浅色模式变量 */
            --bg-base: #f9f9f9;
            --text-color: #111;
            --blur-bg: rgba(255, 255, 255, 0.4);
            --border-color: rgba(0, 0, 0, 0.1);
            --accent-color: #1a73e8; /* 采用 Google 蓝 */
            --shadow-color: rgba(0, 0, 0, 0.15);
            --radius-large: 16px;
            --radius-small: 8px;
            --transition-speed: 0.3s ease;
        }

        /* 深色模式覆盖 */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-base: #1c1c1e;
                --text-color: #fff;
                --blur-bg: rgba(0, 0, 0, 0.4);
                --border-color: rgba(255, 255, 255, 0.1);
                --shadow-color: rgba(0, 0, 0, 0.4);
            }
        }

        /* 2. 全局和布局样式 */
        * {
            font-family: 'Inter', sans-serif !important; 
            font-weight: 400;
            box-sizing: border-box;
            font-style: normal;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: var(--bg-base);
            color: var(--text-color);
            overflow-x: hidden; 
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.5s ease;
        }
        
        #container {
            position: relative;
            width: 100vw;
            min-height: 100vh;
        }

        /* 3. 背景和主图片 (略) */
        #bg-blur {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            filter: blur(40px) brightness(0.7);
            transform: scale(1.05);
            opacity: 0;
            z-index: 0;
            transition: opacity 0.8s ease;
        }

        #img {
            position: fixed;
            top: 0;
            left: 0;
            max-width: 100vw;
            max-height: 100vh;
            width: 100%;
            height: 100%;
            object-fit: contain;
            user-select: none;
            pointer-events: auto;
            opacity: 0;
            z-index: 1;
            transition: opacity 0.5s ease;
            display: none;
        }
        
        /* 4. 信息模块：时钟+天气+一言 (核心修改区域) */
        #info-widget {
            position: fixed;
            z-index: 10;
            padding: 20px 30px;
            max-width: 400px;
            min-width: 300px;
            text-align: center;
            color: var(--text-color);
            text-shadow: 0 1px 4px var(--shadow-color);
            background: var(--blur-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-large);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 30px var(--shadow-color);
            cursor: grab;
            transform: translate(-50%, -50%); /* 保持居中初始定位 */
            top: 50%; 
            left: 50%; 
            transition: opacity var(--transition-speed);
            
            /* --- 新增/修改：使用 Flexbox 进行内部布局，便于比例控制 --- */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px; /* 增加模块间距 */
            min-height: 200px; /* 确保最小高度，避免内容过少时太小 */
        }
        
        /* 时钟区域 - 占据约 40% 的视觉空间 */
        #clock-area {
            font-size: 3.8em; /* 增大字体 */
            font-weight: 700;
            letter-spacing: -2px;
            line-height: 1.1;】
             /* 1. 强制使用等宽数字（tabular lining/monospaced figures），推荐使用 font-variant-numeric */
            font-variant-numeric: tabular-nums; 
            
            /* 2. 备用/兼容性写法，针对不同浏览器 */
            font-feature-settings: "tnum"; 
            /* Flexbox 布局下，不设置 flex-grow，让它根据内容占据空间，但字体大起到突出作用 */
        }

        /* 天气区域 - 占据约 30% 的视觉空间 (通过字体和排版) */
        #weather-area {
            /* 移除原有的 text-align: center，因为父级已设置 */
            width: 100%; 
            padding: 10px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #weather-display {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.2em; /* 适中字体 */
            font-weight: 500;
            justify-content: center;
        }

        #weather-icon {
            font-size: 1.5em; /* 突出图标 */
        }
        
        /* 一言区域 - 占据约 30% 的视觉空间 */
        #hitokoto-area {
            text-align: center;
            font-size: 0.95em; /* 略小字体，强调内容而非大小 */
            flex-grow: 1; /* 占据剩余空间，但内容驱动高度 */

            flex-direction: column;
            justify-content: center;
            width: 100%;
        }

        #hitokoto-content {
            font-style: italic;
            margin-bottom: 5px;
            line-height: 1.4;
        }

        #hitokoto-meta {
            font-size: 0.8em;
            opacity: 0.8;
        }
        /* --- 核心修改区域结束 --- */


        /* 5. 功能区（Dock）和按钮样式 */
        #function-container {
            position: fixed;
            top: 20px; 
            right: 20px; 
            z-index: 20;
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            align-items: flex-end; 
            cursor: grab; 
            /* 移除 transition: all, 避免干扰拖拽定位 */
            transition: opacity var(--transition-speed); 
        }

        /* 当拖拽到左侧时，展开方向改为左侧 */
        #function-container[data-align="left"] #function-buttons {
            align-items: flex-start;
        }
        #function-container[data-align="left"] {
            align-items: flex-start;
        }

        .control-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--blur-bg);
            backdrop-filter: blur(15px);
            color: var(--text-color);
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: background var(--transition-speed), transform 0.2s ease;
        }

        #function-buttons {
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            max-height: 400px;
            align-items: inherit; 
            transition: max-height var(--transition-speed), opacity var(--transition-speed);
        }

        #function-container.collapsed #function-buttons {
            max-height: 0;
            opacity: 0;
            pointer-events: none;
            margin-bottom: -10px;
        }
        
        /* 6. 源选择区 - 调整到右上角，完全隐藏按钮列表 */
        #source-container {
            position: fixed;
            top: 20px;
            right: 100px; /* 默认向右多一些，留出功能区位置 */
            z-index: 20;
            display: flex;
            align-items: center;
            cursor: grab; 
            /* 移除 transition: all, 避免干扰拖拽定位 */
            transition: opacity var(--transition-speed);
        }
        
        /* 源按钮列表 - 初始状态完全隐藏到右侧 */
        #source-buttons {
            display: flex;
            gap: 8px;
            padding: 10px;
            margin-right: 50px;
            background: var(--blur-bg);
            backdrop-filter: blur(15px);
            border-radius: 30px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px var(--shadow-color);
            
            /* 核心修改：完全隐藏到右侧，只留出 source-toggle 按钮 */
            transform: translateX(100%); 
            opacity: 0; /* 初始不透明度为 0 */
            pointer-events: none; /* 初始不可点击 */
            
            /* 展开时的动画 */
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s ease;
        }
        
        #source-container.expanded #source-buttons {
            transform: translateX(0); /* 滑出 */
            opacity: 1; /* 完全显示 */
            pointer-events: auto;
        }

        /* 切换按钮定位：固定在右侧，与 function-container 错开 */
        #btn-source-toggle {
            position: absolute;
            right: 0;
        }

        .src-block {
            width: 40px;
            height: 40px;
            border-radius: 50%; 
            background-color: var(--accent-color);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .src-block.selected {
            outline: 3px solid var(--accent-color);
            outline-offset: 2px;
            transform: scale(1.1);
        }

        /* 7. Toast 提示 (略) */
        #toast {
            position: fixed;
            bottom: 100px;
            right: 100px;
            background: (var(--blur-bg));
            color: #fff;
            padding: 8px 16px;
            border-radius: var(--radius-small);
            font-weight: 500;
            font-size: 14px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 1000;
        }

        /* 8. 城市选择器样式 (略) */
        #city-selector-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            background: var(--blur-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-large);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 30px var(--shadow-color);
            padding: 20px;
            display: none; /* 默认隐藏 */
            flex-direction: column;
        }
        
        .selector-header {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .selector-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .selector-item {
            padding: 8px 15px;
            background-color: var(--accent-color);
            color: #fff;
            border-radius: var(--radius-small);
            cursor: pointer;
            transition: transform 0.1s, opacity 0.1s;
            font-weight: 500;
        }

        .selector-item:hover {
            opacity: 0.8;
        }

        #city-back-button {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            margin-right: 10px;
            display: none; /* 城市列表时显示 */
        }
        
        #city-selector-container:not([data-step="city"]) #city-back-button {
             display: none;
        }
        #city-selector-container[data-step="city"] #city-back-button {
             display: inline-block;
        }
    </style>
</head>

<body>
    <div id="container" role="main" aria-label="桌面壁纸展示区">
        <img id="bg-blur" aria-hidden="true" alt="">

        <img id="img" alt="随机桌面壁纸">

        <div id="progress-container" aria-hidden="true">
            <div class="spinner"></div>
            <div id="progress-text" role="alert" aria-live="assertive"></div>
        </div>

        <div id="info-widget" class="info-widget" aria-live="polite" aria-label="时钟、天气和一言" draggable="true" style="display: block; transition-property: opacity, max-height, max-width, background, backdrop-filter, box-shadow, transform; cursor: grab; touch-action: none;">
            <div id="clock-area" style="display: block;">21:57:00</div>
            
            <div id="weather-area" style="display: block;">
                <div id="weather-display">
                    <span id="weather-icon">☁️</span>
                    <span id="location-text">Ip</span>
                    <span id="temp-text">12°C</span>
                </div>
            </div>
            
            <div id="hitokoto-area" style="display: block;">
                <div id="hitokoto-content">奇怪的是，当他死去，所有人才开始爱他。</div>
                <div id="hitokoto-meta">—— 崔雪莉 出自《哲学》</div>
            </div>
        </div>

        <div id="source-container" class="collapsed" style="transition-property: opacity, max-height, max-width, background, backdrop-filter, box-shadow, transform; cursor: grab; touch-action: none; position: fixed; left: 1225.4px; top: 392px; right: unset; bottom: unset; transform: none;">
            <div id="source-buttons" role="group" aria-label="图片源选择" style="transform: translateX(100%); opacity: 0; pointer-events: none;"><div class="src-block selected" role="button" tabindex="0" aria-label="图片源 I" data-index="0" style="background-color: rgb(13, 147, 242);">I</div><div class="src-block" role="button" tabindex="0" aria-label="图片源 II" data-index="1" style="background-color: rgb(27, 187, 27);">II</div><div class="src-block" role="button" tabindex="0" aria-label="图片源 III" data-index="2" style="background-color: rgb(212, 17, 115);">III</div><div class="src-block" role="button" tabindex="0" aria-label="图片源 IV" data-index="3" style="background-color: rgb(239, 175, 46);">IV</div><div class="src-block" role="button" tabindex="0" aria-label="图片源 V" data-index="4" style="background-color: rgb(163, 51, 219);">V</div><div class="src-block" role="button" tabindex="0" aria-label="图片源 VI" data-index="5" style="background-color: rgb(208, 80, 37);">VI</div><div class="src-block" role="button" tabindex="0" aria-label="图片源 VII" data-index="6" style="background-color: rgb(48, 201, 232);">VII</div><div class="src-block" role="button" tabindex="0" aria-label="图片源 VIII" data-index="7" style="background-color: rgb(163, 51, 219);">VIII</div></div>
            <button id="btn-source-toggle" class="control-button" title="切换图片源 (H)" type="button" tabindex="0">
                <i class="icon-source">源</i>
            </button>
        </div>

        <div id="function-container" class="collapsed" aria-label="功能区" aria-expanded="false" data-align="right" style="transition-property: opacity, max-height, max-width, background, backdrop-filter, box-shadow, transform; cursor: grab; touch-action: none;">
            <div id="function-buttons" role="group" aria-label="功能区按钮组">

                <button id="btn-clock-toggle" class="control-button" type="button" title="隐藏时钟">
                    <i class="icon-clock">🕒</i>
                </button>
                <button id="btn-weather-toggle" class="control-button" type="button" title="隐藏天气">
                    <i class="icon-weather">☁</i>
                </button>
                <button id="btn-hitokoto-toggle" class="control-button" type="button" title="隐藏一言 (U)">
                    <i class="icon-hitokoto">❝</i>
                </button>

                <button id="btn-city-search" class="control-button" type="button" title="搜索城市天气">
                    <i class="icon-search">🔍</i>
                </button>
                
                <button id="btn-refresh" class="control-button" type="button" title="刷新壁纸 (R)">
                    <i class="icon-refresh">↻</i>
                </button>
                <button id="btn-hitokoto-refresh" class="control-button" type="button" title="刷新一言/天气 (Y)">
                    <i class="icon-quote">🔄</i>
                </button>
                <button id="btn-wallpaper-toggle" class="control-button" type="button" title="切换壁纸显示 (T)">
                    <i class="icon-wallpaper-toggle">🖼</i>
                </button>
            </div>
            <button id="toggle-button" class="control-button" aria-label="展开功能区 (K)" type="button" tabindex="0">
                <i class="icon-toggle">↑</i>
            </button>
        </div>

        <div id="city-selector-container" role="dialog" aria-modal="true" aria-label="城市选择器" data-step="province">
            <div class="selector-header">
                <button id="city-back-button" title="返回省份选择">←</button>
                <span id="selector-title">请选择省份/直辖市</span>
                <button id="city-close-button" class="control-button" title="关闭选择器">✖</button>
            </div>
            <div id="province-list" class="selector-list"></div>
            <div id="city-list" class="selector-list" style="display: none;"></div>
        </div>

        <div id="toast" role="alert" aria-live="assertive" aria-atomic="true" style="opacity: 0; transform: translateY(10px);">源选择已收起</div>
    </div>

    <script>
        (function () {
            // DOM引用 (保持不变)
            const bgBlur = document.getElementById('bg-blur');
            const img = document.getElementById('img');
            const progressContainer = document.getElementById('progress-container');
            const toast = document.getElementById('toast');
            
            const infoWidget = document.getElementById('info-widget');
            const sourceContainer = document.getElementById('source-container');
            const functionContainer = document.getElementById('function-container');

            const clockArea = document.getElementById('clock-area');
            const weatherArea = document.getElementById('weather-area');
            const hitokotoArea = document.getElementById('hitokoto-area');
            const locationText = document.getElementById('location-text');
            const tempText = document.getElementById('temp-text');
            const weatherIcon = document.getElementById('weather-icon');
            const hitokotoContent = document.getElementById('hitokoto-content');
            const hitokotoMeta = document.getElementById('hitokoto-meta');
            const sourceButtons = document.getElementById('source-buttons');

            const toggleButton = document.getElementById('toggle-button');
            const btnRefresh = document.getElementById('btn-refresh');
            const btnHitokotoRefresh = document.getElementById('btn-hitokoto-refresh');
            const btnSourceToggle = document.getElementById('btn-source-toggle');
            const btnWallpaperToggle = document.getElementById('btn-wallpaper-toggle');
            const btnClockToggle = document.getElementById('btn-clock-toggle');
            const btnWeatherToggle = document.getElementById('btn-weather-toggle');
            const btnHitokotoToggle = document.getElementById('btn-hitokoto-toggle');
            const btnCitySearch = document.getElementById('btn-city-search');
            
            const citySelectorContainer = document.getElementById('city-selector-container');
            const provinceList = document.getElementById('province-list');
            const cityList = document.getElementById('city-list');
            const cityCloseButton = document.getElementById('city-close-button');
            const cityBackButton = document.getElementById('city-back-button');
            const selectorTitle = document.getElementById('selector-title');

            // 状态变量 (保持不变)
            let currentSourceIndex = 0;
            let sourcePanelExpanded = false;
            let hasImageLoadedSuccessfully = false;
            let currentCity = null; 
            let cachedGeo = null;
            let cachedWeather = null;
            let currentProvince = null;

            // 图片源配置 (保持不变)
            const sources = [
                { url: 'https://www.onexiaolaji.cn/RandomPicture/api/?key=qq249663924&class=2', label: 'I', color: 'hsl(205,90%,50%)' },
                { url: 'https://www.onexiaolaji.cn/RandomPicture/api/?key=qq249663924&class=4', label: 'II', color: 'hsl(120,75%,42%)' },
                { url: 'https://api.r10086.com/樱道随机图片api接口.php?图片系列=极品美女图片', label: 'III', color: 'hsl(330,85%,45%)' },
                { url: 'https://api.r10086.com/樱道随机图片api接口.php?图片系列=日本COS中国COS', label: 'IV', color: 'hsl(40,86%,56%)' },
                { url: 'https://api.r10086.com/樱道随机图片api接口.php?图片系列=少女写真5', label: 'V', color: 'hsl(280,70%,53%)' },
                { url: 'https://api.r10086.com/樱道随机图片api接口.php?图片系列=少女写真6', label: 'VI', color: 'hsl(15,70%,48%)' },
                { url: 'https://api.lolimi.cn/API/meizi/api.php?type=image', label: 'VII', color: 'hsl(190,80%,55%)' },
                { url: 'https://api.lolimi.cn/API/meinv/api.php?type=image', label: 'VIII', color: 'hsl(280,70%,53%)' }
            ];
            
            /* * 核心修改 3: 城市清单优化
             * * 方案：使用更完整的硬编码城市列表，并在注释中指出 API 优化方向。
             * 完整的城市数据应通过高德/百度地图API或专门的地理服务获取，以避免客户端硬编码。
             * 这里使用一个较完整的硬编码列表来满足当前需求。
             */
            const CN_CITIES_FULL = {
                "北京": ["北京"], "上海": ["上海"], "天津": ["天津"], "重庆": ["重庆"],
                "河北": ["石家庄", "唐山", "秦皇岛", "邯郸", "邢台", "保定", "张家口", "承德", "沧州", "廊坊", "衡水"],
                "山西": ["太原", "大同", "阳泉", "长治", "晋城", "朔州", "晋中", "运城", "忻州", "临汾", "吕梁"],
                "辽宁": ["沈阳", "大连", "鞍山", "抚顺", "本溪", "丹东", "锦州", "营口", "阜新", "辽阳", "盘锦", "铁岭", "朝阳", "葫芦岛"],
                "吉林": ["长春", "吉林", "四平", "辽源", "通化", "白山", "松原", "白城", "延边"],
                "黑龙江": ["哈尔滨", "齐齐哈尔", "鸡西", "鹤岗", "双鸭山", "大庆", "伊春", "佳木斯", "七台河", "牡丹江", "黑河", "绥化", "大兴安岭"],
                "江苏": ["南京", "无锡", "徐州", "常州", "苏州", "南通", "连云港", "淮安", "盐城", "扬州", "镇江", "泰州", "宿迁"],
                "浙江": ["杭州", "宁波", "温州", "嘉兴", "湖州", "绍兴", "金华", "衢州", "舟山", "台州", "丽水"],
                "安徽": ["合肥", "芜湖", "蚌埠", "淮南", "马鞍山", "淮北", "铜陵", "安庆", "黄山", "滁州", "阜阳", "宿州", "六安", "亳州", "池州", "宣城"],
                "福建": ["福州", "厦门", "莆田", "三明", "泉州", "漳州", "南平", "龙岩", "宁德"],
                "江西": ["南昌", "景德镇", "萍乡", "九江", "新余", "鹰潭", "赣州", "吉安", "宜春", "抚州", "上饶"],
                "山东": ["济南", "青岛", "淄博", "枣庄", "东营", "烟台", "潍坊", "济宁", "泰安", "威海", "日照", "临沂", "德州", "聊城", "滨州", "菏泽"],
                "河南": ["郑州", "开封", "洛阳", "平顶山", "安阳", "鹤壁", "新乡", "焦作", "濮阳", "许昌", "漯河", "三门峡", "南阳", "商丘", "信阳", "周口", "驻马店"],
                "湖北": ["武汉", "黄石", "十堰", "宜昌", "襄阳", "鄂州", "荆门", "孝感", "荆州", "黄冈", "咸宁", "随州", "恩施", "仙桃", "潜江", "天门", "神农架"],
                "湖南": ["长沙", "株洲", "湘潭", "衡阳", "邵阳", "岳阳", "常德", "张家界", "益阳", "郴州", "永州", "怀化", "娄底", "湘西"],
                "广东": ["广州", "韶关", "深圳", "珠海", "汕头", "佛山", "江门", "湛江", "茂名", "肇庆", "惠州", "梅州", "汕尾", "河源", "阳江", "清远", "东莞", "中山", "潮州", "揭阳", "云浮"],
                "海南": ["海口", "三亚", "三沙", "儋州", "五指山", "琼海", "文昌", "万宁", "东方"],
                "四川": ["成都", "自贡", "攀枝花", "泸州", "德阳", "绵阳", "广元", "遂宁", "内江", "乐山", "南充", "眉山", "宜宾", "广安", "达州", "雅安", "巴中", "资阳", "阿坝", "甘孜", "凉山"],
                "贵州": ["贵阳", "六盘水", "遵义", "安顺", "毕节", "铜仁", "黔西南", "黔东南", "黔南"],
                "云南": ["昆明", "曲靖", "玉溪", "保山", "昭通", "丽江", "普洱", "临沧", "楚雄", "红河", "文山", "西双版纳", "大理", "德宏", "怒江", "迪庆"],
                "陕西": ["西安", "铜川", "宝鸡", "咸阳", "渭南", "延安", "汉中", "榆林", "安康", "商洛"],
                "甘肃": ["兰州", "嘉峪关", "金昌", "白银", "天水", "武威", "张掖", "平凉", "酒泉", "庆阳", "定西", "陇南", "临夏", "甘南"],
                "青海": ["西宁", "海东", "海北", "黄南", "海南", "果洛", "玉树", "海西"],
                "宁夏": ["银川", "石嘴山", "吴忠", "固原", "中卫"],
                "新疆": ["乌鲁木齐", "克拉玛依", "吐鲁番", "哈密", "昌吉", "博尔塔拉", "巴音郭楞", "阿克苏", "克孜勒苏", "喀什", "和田", "伊犁", "塔城", "阿勒泰"],
                "内蒙古": ["呼和浩特", "包头", "乌海", "赤峰", "通辽", "鄂尔多斯", "呼伦贝尔", "巴彦淖尔", "乌兰察布", "兴安", "锡林郭勒", "阿拉善"],
                "西藏": ["拉萨", "日喀则", "昌都", "林芝", "山南", "那曲", "阿里"],
                "广西": ["南宁", "柳州", "桂林", "梧州", "北海", "防城港", "钦州", "贵港", "玉林", "百色", "贺州", "河池", "来宾", "崇左"],
                "香港": ["香港"], "澳门": ["澳门"], "台湾": ["台北", "高雄", "台中", "台南", "桃园", "新北", "基隆", "新竹", "嘉义"]
            };

            let toastTimeout = null;
            function showToast(msg) { /* ... 保持不变 ... */
                toast.textContent = msg;
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
                if (toastTimeout) clearTimeout(toastTimeout);
                toastTimeout = setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(10px)';
                }, 2000);
            }

            /* * 核心修改 1: 拖拽功能实现 - 取消吸附屏幕边缘
             * * 移除 clampPosition 中的吸附逻辑，只保留边界限制，
             * 移除 onPointerUp 中的吸附/对齐/data-align 逻辑。
             */
            function clampPosition(x, y, elem) {
                const rect = elem.getBoundingClientRect();
                const width = rect.width;
                const height = rect.height;
                let newX = Math.max(0, x);
                let newY = Math.max(0, y);
                newX = Math.min(newX, window.innerWidth - width);
                newY = Math.min(newY, window.innerHeight - height);
                return [newX, newY];
            }

            function makeDraggable(elem) {
                let dragging = false;
                let offsetX = 0;
                let offsetY = 0;
                let isTouch = false;
                
                elem.style.transitionProperty = 'opacity, max-height, max-width, background, backdrop-filter, box-shadow, transform';
                elem.style.cursor = 'grab';

                function onPointerDown(e) {
                    if (elem.id !== 'info-widget' && e.target.closest('button, input, a, .src-block')) {
                         return; 
                    }
                    if (elem.id === 'info-widget' && e.target.closest('input, button, a')) {
                         return;
                    }
                    
                    isTouch = !!e.touches;
                    if (e.button !== 0 && !isTouch) return;
                    
                    dragging = true;
                    elem.style.cursor = 'grabbing';

                    let clientX = e.clientX ?? (e.touches && e.touches[0].clientX);
                    let clientY = e.clientY ?? (e.touches && e.touches[0].clientY);
                    
                    const rect = elem.getBoundingClientRect();
                    offsetX = clientX - rect.left;
                    offsetY = clientY - rect.top;

                    // 将元素的定位转换为绝对像素定位
                    elem.style.position = 'fixed';
                    elem.style.left = rect.left + 'px';
                    elem.style.top = rect.top + 'px';
                    elem.style.right = 'unset';
                    elem.style.bottom = 'unset';
                    elem.style.transform = 'none'; 
                    
                    // 移除功能区的 data-align 属性，因为已不再需要靠边界对齐来判断展开方向
                    if (elem === functionContainer) {
                         elem.removeAttribute('data-align');
                    }


                    if (!isTouch) e.preventDefault(); 
                    e.stopPropagation();
                }

                function onPointerMove(e) {
                    if (!dragging) return;
                    
                    let clientX = e.clientX ?? (e.touches && e.touches[0].clientX);
                    let clientY = e.clientY ?? (e.touches && e.touches[0].clientY);

                    let newX = clientX - offsetX;
                    let newY = clientY - offsetY;

                    requestAnimationFrame(() => {
                        if (dragging) {
                            // 保持边界限制，但不做吸附
                            [newX, newY] = clampPosition(newX, newY, elem); 
                            elem.style.left = newX + 'px';
                            elem.style.top = newY + 'px';
                        }
                    });

                    if (isTouch) e.preventDefault();
                    e.stopPropagation();
                }

                function onPointerUp() {
                    if (dragging) {
                        dragging = false;
                        elem.style.cursor = 'grab';
                        isTouch = false;
                        
                        // 移除所有的吸附和对齐逻辑
                    }
                }

                elem.style.touchAction = 'none';
                elem.addEventListener('mousedown', onPointerDown);
                elem.addEventListener('touchstart', onPointerDown, { passive: false });
                window.addEventListener('mousemove', onPointerMove);
                window.addEventListener('touchmove', onPointerMove, { passive: false });
                window.addEventListener('mouseup', onPointerUp);
                window.addEventListener('touchend', onPointerUp);
                window.addEventListener('touchcancel', onPointerUp);
            }
            
            // ... (时钟、天气、图片刷新、一言功能代码保持不变) ...

            // 城市选择面板切换（实现完全隐藏）
            function toggleSourcePanel(expand) {
                if (typeof expand === 'undefined') {
                    sourcePanelExpanded = !sourcePanelExpanded;
                } else {
                    sourcePanelExpanded = expand;
                }
                
                if (sourcePanelExpanded) {
                    sourceContainer.classList.add('expanded');
                    sourceButtons.style.transform = 'translateX(0)';
                    sourceButtons.style.opacity = '1';
                    sourceButtons.style.pointerEvents = 'auto';
                } else {
                    sourceContainer.classList.remove('expanded');
                    sourceButtons.style.transform = 'translateX(100%)';
                    sourceButtons.style.opacity = '0';
                    sourceButtons.style.pointerEvents = 'none';
                }
                
                btnSourceToggle.querySelector('i').textContent = sourcePanelExpanded ? '✖' : '源';
                showToast(sourcePanelExpanded ? '源选择已展开' : '源选择已收起');
            }


            // 新的城市选择交互逻辑
            
            // 步骤一：加载省份列表 (使用 CN_CITIES_FULL)
            function loadProvinces() {
                citySelectorContainer.setAttribute('data-step', 'province');
                selectorTitle.textContent = '请选择省份/直辖市';
                provinceList.style.display = 'flex';
                cityList.style.display = 'none';
                provinceList.innerHTML = '';
                
                Object.keys(CN_CITIES_FULL).forEach(province => {
                    const item = document.createElement('div');
                    item.className = 'selector-item';
                    item.textContent = province;
                    item.addEventListener('click', () => loadCities(province));
                    provinceList.appendChild(item);
                });
            }

            // 步骤二：加载城市列表 (使用 CN_CITIES_FULL)
            function loadCities(province) {
                currentProvince = province;
                citySelectorContainer.setAttribute('data-step', 'city');
                selectorTitle.textContent = `请选择 ${province} 的城市`;
                provinceList.style.display = 'none';
                cityList.style.display = 'flex';
                cityList.innerHTML = '';

                const cities = CN_CITIES_FULL[province] || [];
                cities.forEach(city => {
                    const item = document.createElement('div');
                    item.className = 'selector-item';
                    item.textContent = city;
                    item.addEventListener('click', () => selectCity(city));
                    cityList.appendChild(item);
                });
            }

            // 步骤三：选择城市并获取天气 (保持不变)
            function selectCity(city) {
                citySelectorContainer.style.display = 'none';
                showToast(`正在查询 ${city} 的天气...`);
                fetchWeather(city); // 调用原有的 fetchWeather 函数
            }
            
            // 城市搜索事件处理器 (保持不变)
            function handleCitySearchClick() {
                citySelectorContainer.style.display = 'flex';
                loadProvinces();
            }

            // 绑定城市选择器的关闭和返回按钮 (保持不变)
            cityCloseButton.addEventListener('click', () => {
                citySelectorContainer.style.display = 'none';
                showToast('城市选择已取消');
            });
            
            cityBackButton.addEventListener('click', () => {
                loadProvinces();
                currentProvince = null;
            });

            // 其他辅助函数和初始化逻辑 (保持不变)
            function updateClock() { /* ... 保持不变 ... */
                const now = new Date();
                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                const s = String(now.getSeconds()).padStart(2, '0');
                clockArea.textContent = `${h}:${m}:${s}`;
            }

            async function getGeoLocation(cityName = null) { /* ... 保持不变 ... */
                locationText.textContent = '定位中...';
                if (cityName) {
                    try {
                        const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityName)}&count=1&language=zh&format=json`);
                        if (!response.ok) throw new Error('Failed to fetch city geo');
                        const data = await response.json();
                        if (data.results && data.results.length > 0) {
                            const geo = data.results[0];
                            return { lat: geo.latitude, lon: geo.longitude, name: geo.name || cityName }; 
                        } else {
                            throw new Error('City not found');
                        }
                    } catch (error) {
                        console.error('通过城市名获取地理位置失败:', error);
                        showToast(`未找到城市: ${cityName}`);
                        return null; 
                    }
                } else {
                    if (cachedGeo && !currentCity) return cachedGeo;
                    try {
                        const response = await fetch('https://geocoding-api.open-meteo.com/v1/search?name=ip&count=1&language=zh&format=json');
                        if (!response.ok) throw new Error('Failed to fetch IP geo');
                        const data = await response.json();
                        if (data.results && data.results.length > 0) {
                            const geo = data.results[0];
                            const locationName = geo.name || geo.country || '未知位置';
                            cachedGeo = { lat: geo.latitude, lon: geo.longitude, name: locationName };
                            return cachedGeo;
                        }
                    } catch (error) {
                        console.error('获取 IP 地理位置失败:', error);
                    }
                }
                return { lat: 0, lon: 0, name: '位置未知' };
            }

            async function fetchWeather(cityName = null) { /* ... 保持不变 ... */
                 // 逻辑保持不变，确保调用 getGeoLocation
                if (!cityName && cachedWeather && !currentCity) return;
                
                if (cityName) {
                    currentCity = cityName;
                    cachedGeo = null; 
                } else if (!currentCity) {
                    currentCity = null; 
                }

                locationText.textContent = cityName ? `${cityName}...` : '定位中...';
                tempText.textContent = '--°C';
                weatherIcon.textContent = '...';

                const geo = await getGeoLocation(cityName);
                if (!geo || (geo.lat === 0 && geo.lon === 0 && geo.name === '位置未知')) {
                    if (cityName) currentCity = null; 
                    return;
                }
                
                locationText.textContent = geo.name;

                try {
                    const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${geo.lat}&longitude=${geo.lon}&current=temperature_2m,weather_code&timezone=auto&forecast_days=1`;
                    const response = await fetch(weatherUrl);
                    if (!response.ok) throw new Error('Failed to fetch weather');
                    const data = await response.json();
                    
                    const temp = Math.round(data.current.temperature_2m);
                    const code = data.current.weather_code;
                    const weatherStatus = getWeatherEmoji(code);

                    tempText.textContent = `${temp}°C`;
                    weatherIcon.textContent = weatherStatus;
                    cachedWeather = { temp, code, status: weatherStatus };
                    showToast(`${geo.name} 天气: ${weatherStatus} ${temp}°C`);

                } catch (error) {
                    console.error('获取天气信息失败:', error);
                    tempText.textContent = 'N/A';
                    weatherIcon.textContent = '⚠️';
                    showToast('获取天气信息失败');
                }
            }

            function getWeatherEmoji(code) { /* ... 保持不变 ... */
                if (code >= 0 && code <= 1) return '☀️'; 
                if (code >= 2 && code <= 3) return '☁️'; 
                if (code >= 45 && code <= 48) return '🌫️'; 
                if (code >= 51 && code <= 55) return '🌧️'; 
                if (code >= 61 && code <= 65) return '🌧️'; 
                if (code >= 71 && code <= 75) return '🌨️'; 
                if (code >= 80 && code <= 82) return '⛈️'; 
                if (code >= 85 && code <= 86) return '❄️'; 
                if (code === 95) return '⛈️'; 
                return '❓';
            }

            function initSourceBlocks() { /* ... 保持不变 ... */
                 sourceButtons.innerHTML = '';
                sources.forEach(({ label, color }, i) => {
                    const block = document.createElement('div');
                    block.className = 'src-block';
                    block.style.backgroundColor = color;
                    block.setAttribute('role', 'button');
                    block.setAttribute('tabindex', '0');
                    block.setAttribute('aria-label', '图片源 ' + label);
                    block.textContent = label;
                    block.dataset.index = i;

                    block.addEventListener('click', () => {
                        if (currentSourceIndex !== i) {
                            currentSourceIndex = i;
                            updateSelectedBlock();
                            toggleSourcePanel(false);
                            refreshImage();
                        }
                    });
                    sourceButtons.appendChild(block);
                });
                updateSelectedBlock();
            }

            function updateSelectedBlock() { /* ... 保持不变 ... */
                 sourceButtons.querySelectorAll('.src-block').forEach((block, i) => {
                    block.classList.toggle('selected', i === currentSourceIndex);
                });
            }

            async function refreshImage() { /* ... 保持不变 ... */
                let url = sources[currentSourceIndex].url;
                let fullUrl = url + (url.includes('?') ? '&' : '?') + '_ts=' + Date.now();

                progressContainer.style.display = 'flex';
                img.style.opacity = '0';
                img.style.display = 'block';
                bgBlur.style.display = 'block';

                const imageLoader = new Image();
                imageLoader.onload = async () => {
                    img.src = fullUrl;
                    bgBlur.src = fullUrl;
                    
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        img.style.opacity = '1';
                        bgBlur.style.opacity = '0.3';
                        hasImageLoadedSuccessfully = true;
                        btnWallpaperToggle.querySelector('i').textContent = '🖼';
                    }, 100);
                };

                imageLoader.onerror = () => {
                    progressContainer.style.display = 'none';
                    img.style.display = 'none';
                    bgBlur.style.opacity = '0';
                    setTimeout(() => bgBlur.style.display = 'none', 300);
                    hasImageLoadedSuccessfully = false;
                    btnWallpaperToggle.querySelector('i').textContent = '🖼';
                    showToast('壁纸加载失败');
                };

                imageLoader.src = fullUrl;
            }

            async function fetchHitokoto() { /* ... 保持不变 ... */
                hitokotoContent.textContent = '正在加载...';
                hitokotoMeta.textContent = '';
                try {
                    const r = await fetch('https://v1.hitokoto.cn/');
                    const data = await r.json();
                    hitokotoContent.textContent = data.hitokoto;
                    hitokotoMeta.textContent = `—— ${data.from_who || '佚名'} 出自《${data.from}》`;
                } catch {
                    hitokotoContent.textContent = '获取一言失败。';
                    hitokotoMeta.textContent = '';
                }
            }
            
            function toggleModule(moduleElement, button, name) { /* ... 保持不变 ... */
                const isVisible = moduleElement.style.display !== 'none';
                
                moduleElement.style.display = isVisible ? 'none' : 'block';
                
                button.style.opacity = isVisible ? '0.5' : '1';
                button.title = (isVisible ? '显示' : '隐藏') + name;
                showToast(name + (isVisible ? ' 已隐藏' : ' 已显示'));
            }

            function toggleFunctionArea() { /* ... 保持不变 ... */
                const isCollapsed = functionContainer.classList.toggle('collapsed');
                const icon = isCollapsed ? '↑' : '↓';
                toggleButton.querySelector('i').textContent = icon;
                functionContainer.setAttribute('aria-expanded', !isCollapsed);
                showToast(isCollapsed ? '功能区已收起' : '功能区已展开');
            }

            function toggleWallpaper() { /* ... 保持不变 ... */
                if (!hasImageLoadedSuccessfully) {
                    showToast('请先选择源并加载壁纸');
                    return;
                }

                const isVisible = img.style.opacity === '1';

                if (isVisible) {
                    img.style.opacity = '0';
                    btnWallpaperToggle.querySelector('i').textContent = '✖';
                    btnWallpaperToggle.title = '显示壁纸 (T)';
                    showToast('壁纸已隐藏');
                } else {
                    img.style.opacity = '1';
                    btnWallpaperToggle.querySelector('i').textContent = '🖼';
                    btnWallpaperToggle.title = '隐藏壁纸 (T)';
                    showToast('壁纸已显示');
                }
            }


            // 6. 初始化和事件绑定
            window.addEventListener('DOMContentLoaded', () => {
                initSourceBlocks();
                
                // 启用拖拽功能 (已修改)
                makeDraggable(infoWidget); 
                makeDraggable(sourceContainer);
                makeDraggable(functionContainer);
                
                // 确保功能区和源选择区在右上角的初始定位正确
                // 由于取消了吸附，不再设置 data-align，使用 CSS 默认的 right 对齐
                
                // 初始状态
                functionContainer.classList.add('collapsed');
                toggleButton.querySelector('i').textContent = '↑';
                
                // 启动时钟
                updateClock();
                setInterval(updateClock, 1000);

                // 绑定事件
                btnRefresh.addEventListener('click', () => { refreshImage(); showToast('刷新壁纸'); });
                
                btnHitokotoRefresh.addEventListener('click', () => { 
                    fetchHitokoto(); 
                    fetchWeather(currentCity); 
                });
                
                btnSourceToggle.addEventListener('click', () => toggleSourcePanel());
                btnWallpaperToggle.addEventListener('click', toggleWallpaper);
                toggleButton.addEventListener('click', toggleFunctionArea);

                // 独立内容切换事件
                btnClockToggle.addEventListener('click', () => toggleModule(clockArea, btnClockToggle, '时钟'));
                btnWeatherToggle.addEventListener('click', () => toggleModule(weatherArea, btnWeatherToggle, '天气'));
                btnHitokotoToggle.addEventListener('click', () => toggleModule(hitokotoArea, btnHitokotoToggle, '一言'));

                // 搜索城市按钮事件 (新的多步选择)
                btnCitySearch.addEventListener('click', handleCitySearchClick);

                // 默认加载
                fetchHitokoto();
                fetchWeather(); 

                // 快捷键绑定 (添加了对 citySelectorContainer 的检查)
                window.addEventListener('keydown', e => {
                    if (e.isComposing || citySelectorContainer.style.display !== 'none') return; // 弹窗开启时禁用快捷键

                    switch (e.key.toLowerCase()) {
                        case 'r':
                            e.preventDefault();
                            btnRefresh.click();
                            break;
                        case 'y':
                            e.preventDefault();
                            btnHitokotoRefresh.click();
                            break;
                        case 'u':
                            e.preventDefault();
                            btnHitokotoToggle.click();
                            break;
                        case 'h':
                            e.preventDefault();
                            btnSourceToggle.click();
                            break;
                        case 't':
                            e.preventDefault();
                            btnWallpaperToggle.click();
                            break;
                        case 'k':
                            e.preventDefault();
                            toggleButton.click();
                            break;
                    }
                });
            });

        })();
    </script>


</body></html>
<!DOCTYPE html>
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>NSFWall â€“ Lite Edition (New UI v11.0)</title>

    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">

    <style>
        /* 1. åŸºç¡€æ ·å¼å’Œä¸»é¢˜å˜é‡ */
        :root {
            /* æµ…è‰²æ¨¡å¼å˜é‡ */
            --bg-base: #f9f9f9;
            --text-color: #111;
            --blur-bg: rgba(255, 255, 255, 0.4);
            --border-color: rgba(0, 0, 0, 0.1);
            --accent-color: #1a73e8; /* é‡‡ç”¨ Google è“ */
            --shadow-color: rgba(0, 0, 0, 0.15);
            --radius-large: 16px;
            --radius-small: 8px;
            --transition-speed: 0.3s ease;
        }

        /* æ·±è‰²æ¨¡å¼è¦†ç›– */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-base: #1c1c1e;
                --text-color: #fff;
                --blur-bg: rgba(0, 0, 0, 0.4);
                --border-color: rgba(255, 255, 255, 0.1);
                --shadow-color: rgba(0, 0, 0, 0.4);
            }
        }

        /* 2. å…¨å±€å’Œå¸ƒå±€æ ·å¼ */
        * {
            font-family: 'Inter', sans-serif !important; 
            font-weight: 400;
            box-sizing: border-box;
            font-style: normal;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: var(--bg-base);
            color: var(--text-color);
            overflow-x: hidden; 
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.5s ease;
        }
        
        #container {
            position: relative;
            width: 100vw;
            min-height: 100vh;
        }

        /* 3. èƒŒæ™¯å’Œä¸»å›¾ç‰‡ (ç•¥) */
        #bg-blur {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            filter: blur(40px) brightness(0.7);
            transform: scale(1.05);
            opacity: 0;
            z-index: 0;
            transition: opacity 0.8s ease;
        }

        #img {
            position: fixed;
            top: 0;
            left: 0;
            max-width: 100vw;
            max-height: 100vh;
            width: 100%;
            height: 100%;
            object-fit: contain;
            user-select: none;
            pointer-events: auto;
            opacity: 0;
            z-index: 1;
            transition: opacity 0.5s ease;
            display: none;
        }
        
        /* 4. ä¿¡æ¯æ¨¡å—ï¼šæ—¶é’Ÿ+å¤©æ°”+ä¸€è¨€ (æ ¸å¿ƒä¿®æ”¹åŒºåŸŸ) */
        #info-widget {
            position: fixed;
            z-index: 10;
            padding: 20px 30px;
            max-width: 400px;
            min-width: 300px;
            text-align: center;
            color: var(--text-color);
            text-shadow: 0 1px 4px var(--shadow-color);
            background: var(--blur-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-large);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 30px var(--shadow-color);
            cursor: grab;
            transform: translate(-50%, -50%); /* ä¿æŒå±…ä¸­åˆå§‹å®šä½ */
            top: 50%; 
            left: 50%; 
            transition: opacity var(--transition-speed);
            
            /* --- æ–°å¢/ä¿®æ”¹ï¼šä½¿ç”¨ Flexbox è¿›è¡Œå†…éƒ¨å¸ƒå±€ï¼Œä¾¿äºæ¯”ä¾‹æ§åˆ¶ --- */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px; /* å¢åŠ æ¨¡å—é—´è· */
            min-height: 200px; /* ç¡®ä¿æœ€å°é«˜åº¦ï¼Œé¿å…å†…å®¹è¿‡å°‘æ—¶å¤ªå° */
        }
        
        /* æ—¶é’ŸåŒºåŸŸ - å æ®çº¦ 40% çš„è§†è§‰ç©ºé—´ */
        #clock-area {
            font-size: 3.8em; /* å¢å¤§å­—ä½“ */
            font-weight: 700;
            letter-spacing: -2px;
            line-height: 1.1;ã€‘
             /* 1. å¼ºåˆ¶ä½¿ç”¨ç­‰å®½æ•°å­—ï¼ˆtabular lining/monospaced figuresï¼‰ï¼Œæ¨èä½¿ç”¨ font-variant-numeric */
            font-variant-numeric: tabular-nums; 
            
            /* 2. å¤‡ç”¨/å…¼å®¹æ€§å†™æ³•ï¼Œé’ˆå¯¹ä¸åŒæµè§ˆå™¨ */
            font-feature-settings: "tnum"; 
            /* Flexbox å¸ƒå±€ä¸‹ï¼Œä¸è®¾ç½® flex-growï¼Œè®©å®ƒæ ¹æ®å†…å®¹å æ®ç©ºé—´ï¼Œä½†å­—ä½“å¤§èµ·åˆ°çªå‡ºä½œç”¨ */
        }

        /* å¤©æ°”åŒºåŸŸ - å æ®çº¦ 30% çš„è§†è§‰ç©ºé—´ (é€šè¿‡å­—ä½“å’Œæ’ç‰ˆ) */
        #weather-area {
            /* ç§»é™¤åŸæœ‰çš„ text-align: centerï¼Œå› ä¸ºçˆ¶çº§å·²è®¾ç½® */
            width: 100%; 
            padding: 10px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #weather-display {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.2em; /* é€‚ä¸­å­—ä½“ */
            font-weight: 500;
            justify-content: center;
        }

        #weather-icon {
            font-size: 1.5em; /* çªå‡ºå›¾æ ‡ */
        }
        
        /* ä¸€è¨€åŒºåŸŸ - å æ®çº¦ 30% çš„è§†è§‰ç©ºé—´ */
        #hitokoto-area {
            text-align: center;
            font-size: 0.95em; /* ç•¥å°å­—ä½“ï¼Œå¼ºè°ƒå†…å®¹è€Œéå¤§å° */
            flex-grow: 1; /* å æ®å‰©ä½™ç©ºé—´ï¼Œä½†å†…å®¹é©±åŠ¨é«˜åº¦ */

            flex-direction: column;
            justify-content: center;
            width: 100%;
        }

        #hitokoto-content {
            font-style: italic;
            margin-bottom: 5px;
            line-height: 1.4;
        }

        #hitokoto-meta {
            font-size: 0.8em;
            opacity: 0.8;
        }
        /* --- æ ¸å¿ƒä¿®æ”¹åŒºåŸŸç»“æŸ --- */


        /* 5. åŠŸèƒ½åŒºï¼ˆDockï¼‰å’ŒæŒ‰é’®æ ·å¼ */
        #function-container {
            position: fixed;
            top: 20px; 
            right: 20px; 
            z-index: 20;
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            align-items: flex-end; 
            cursor: grab; 
            /* ç§»é™¤ transition: all, é¿å…å¹²æ‰°æ‹–æ‹½å®šä½ */
            transition: opacity var(--transition-speed); 
        }

        /* å½“æ‹–æ‹½åˆ°å·¦ä¾§æ—¶ï¼Œå±•å¼€æ–¹å‘æ”¹ä¸ºå·¦ä¾§ */
        #function-container[data-align="left"] #function-buttons {
            align-items: flex-start;
        }
        #function-container[data-align="left"] {
            align-items: flex-start;
        }

        .control-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--blur-bg);
            backdrop-filter: blur(15px);
            color: var(--text-color);
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: background var(--transition-speed), transform 0.2s ease;
        }

        #function-buttons {
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            max-height: 400px;
            align-items: inherit; 
            transition: max-height var(--transition-speed), opacity var(--transition-speed);
        }

        #function-container.collapsed #function-buttons {
            max-height: 0;
            opacity: 0;
            pointer-events: none;
            margin-bottom: -10px;
        }
        
        /* 6. æºé€‰æ‹©åŒº - è°ƒæ•´åˆ°å³ä¸Šè§’ï¼Œå®Œå…¨éšè—æŒ‰é’®åˆ—è¡¨ */
        #source-container {
            position: fixed;
            top: 20px;
            right: 100px; /* é»˜è®¤å‘å³å¤šä¸€äº›ï¼Œç•™å‡ºåŠŸèƒ½åŒºä½ç½® */
            z-index: 20;
            display: flex;
            align-items: center;
            cursor: grab; 
            /* ç§»é™¤ transition: all, é¿å…å¹²æ‰°æ‹–æ‹½å®šä½ */
            transition: opacity var(--transition-speed);
        }
        
        /* æºæŒ‰é’®åˆ—è¡¨ - åˆå§‹çŠ¶æ€å®Œå…¨éšè—åˆ°å³ä¾§ */
        #source-buttons {
            display: flex;
            gap: 8px;
            padding: 10px;
            margin-right: 50px;
            background: var(--blur-bg);
            backdrop-filter: blur(15px);
            border-radius: 30px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px var(--shadow-color);
            
            /* æ ¸å¿ƒä¿®æ”¹ï¼šå®Œå…¨éšè—åˆ°å³ä¾§ï¼Œåªç•™å‡º source-toggle æŒ‰é’® */
            transform: translateX(100%); 
            opacity: 0; /* åˆå§‹ä¸é€æ˜åº¦ä¸º 0 */
            pointer-events: none; /* åˆå§‹ä¸å¯ç‚¹å‡» */
            
            /* å±•å¼€æ—¶çš„åŠ¨ç”» */
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s ease;
        }
        
        #source-container.expanded #source-buttons {
            transform: translateX(0); /* æ»‘å‡º */
            opacity: 1; /* å®Œå…¨æ˜¾ç¤º */
            pointer-events: auto;
        }

        /* åˆ‡æ¢æŒ‰é’®å®šä½ï¼šå›ºå®šåœ¨å³ä¾§ï¼Œä¸ function-container é”™å¼€ */
        #btn-source-toggle {
            position: absolute;
            right: 0;
        }

        .src-block {
            width: 40px;
            height: 40px;
            border-radius: 50%; 
            background-color: var(--accent-color);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .src-block.selected {
            outline: 3px solid var(--accent-color);
            outline-offset: 2px;
            transform: scale(1.1);
        }

        /* 7. Toast æç¤º (ç•¥) */
        #toast {
            position: fixed;
            bottom: 100px;
            right: 100px;
            background: (var(--blur-bg));
            color: #fff;
            padding: 8px 16px;
            border-radius: var(--radius-small);
            font-weight: 500;
            font-size: 14px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 1000;
        }

        /* 8. åŸå¸‚é€‰æ‹©å™¨æ ·å¼ (ç•¥) */
        #city-selector-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            background: var(--blur-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-large);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 30px var(--shadow-color);
            padding: 20px;
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column;
        }
        
        .selector-header {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .selector-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .selector-item {
            padding: 8px 15px;
            background-color: var(--accent-color);
            color: #fff;
            border-radius: var(--radius-small);
            cursor: pointer;
            transition: transform 0.1s, opacity 0.1s;
            font-weight: 500;
        }

        .selector-item:hover {
            opacity: 0.8;
        }

        #city-back-button {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            margin-right: 10px;
            display: none; /* åŸå¸‚åˆ—è¡¨æ—¶æ˜¾ç¤º */
        }
        
        #city-selector-container:not([data-step="city"]) #city-back-button {
             display: none;
        }
        #city-selector-container[data-step="city"] #city-back-button {
             display: inline-block;
        }
    </style>
</head>

<body>
    <div id="container" role="main" aria-label="æ¡Œé¢å£çº¸å±•ç¤ºåŒº">
        <img id="bg-blur" aria-hidden="true" alt="">

        <img id="img" alt="éšæœºæ¡Œé¢å£çº¸">

        <div id="progress-container" aria-hidden="true">
            <div class="spinner"></div>
            <div id="progress-text" role="alert" aria-live="assertive"></div>
        </div>

        <div id="info-widget" class="info-widget" aria-live="polite" aria-label="æ—¶é’Ÿã€å¤©æ°”å’Œä¸€è¨€" draggable="true" style="display: block; transition-property: opacity, max-height, max-width, background, backdrop-filter, box-shadow, transform; cursor: grab; touch-action: none;">
            <div id="clock-area" style="display: block;">21:57:00</div>
            
            <div id="weather-area" style="display: block;">
                <div id="weather-display">
                    <span id="weather-icon">â˜ï¸</span>
                    <span id="location-text">Ip</span>
                    <span id="temp-text">12Â°C</span>
                </div>
            </div>
            
            <div id="hitokoto-area" style="display: block;">
                <div id="hitokoto-content">å¥‡æ€ªçš„æ˜¯ï¼Œå½“ä»–æ­»å»ï¼Œæ‰€æœ‰äººæ‰å¼€å§‹çˆ±ä»–ã€‚</div>
                <div id="hitokoto-meta">â€”â€” å´”é›ªè‰ å‡ºè‡ªã€Šå“²å­¦ã€‹</div>
            </div>
        </div>

        <div id="source-container" class="collapsed" style="transition-property: opacity, max-height, max-width, background, backdrop-filter, box-shadow, transform; cursor: grab; touch-action: none; position: fixed; left: 1225.4px; top: 392px; right: unset; bottom: unset; transform: none;">
            <div id="source-buttons" role="group" aria-label="å›¾ç‰‡æºé€‰æ‹©" style="transform: translateX(100%); opacity: 0; pointer-events: none;"><div class="src-block selected" role="button" tabindex="0" aria-label="å›¾ç‰‡æº I" data-index="0" style="background-color: rgb(13, 147, 242);">I</div><div class="src-block" role="button" tabindex="0" aria-label="å›¾ç‰‡æº II" data-index="1" style="background-color: rgb(27, 187, 27);">II</div><div class="src-block" role="button" tabindex="0" aria-label="å›¾ç‰‡æº III" data-index="2" style="background-color: rgb(212, 17, 115);">III</div><div class="src-block" role="button" tabindex="0" aria-label="å›¾ç‰‡æº IV" data-index="3" style="background-color: rgb(239, 175, 46);">IV</div><div class="src-block" role="button" tabindex="0" aria-label="å›¾ç‰‡æº V" data-index="4" style="background-color: rgb(163, 51, 219);">V</div><div class="src-block" role="button" tabindex="0" aria-label="å›¾ç‰‡æº VI" data-index="5" style="background-color: rgb(208, 80, 37);">VI</div><div class="src-block" role="button" tabindex="0" aria-label="å›¾ç‰‡æº VII" data-index="6" style="background-color: rgb(48, 201, 232);">VII</div><div class="src-block" role="button" tabindex="0" aria-label="å›¾ç‰‡æº VIII" data-index="7" style="background-color: rgb(163, 51, 219);">VIII</div></div>
            <button id="btn-source-toggle" class="control-button" title="åˆ‡æ¢å›¾ç‰‡æº (H)" type="button" tabindex="0">
                <i class="icon-source">æº</i>
            </button>
        </div>

        <div id="function-container" class="collapsed" aria-label="åŠŸèƒ½åŒº" aria-expanded="false" data-align="right" style="transition-property: opacity, max-height, max-width, background, backdrop-filter, box-shadow, transform; cursor: grab; touch-action: none;">
            <div id="function-buttons" role="group" aria-label="åŠŸèƒ½åŒºæŒ‰é’®ç»„">

                <button id="btn-clock-toggle" class="control-button" type="button" title="éšè—æ—¶é’Ÿ">
                    <i class="icon-clock">ğŸ•’</i>
                </button>
                <button id="btn-weather-toggle" class="control-button" type="button" title="éšè—å¤©æ°”">
                    <i class="icon-weather">â˜</i>
                </button>
                <button id="btn-hitokoto-toggle" class="control-button" type="button" title="éšè—ä¸€è¨€ (U)">
                    <i class="icon-hitokoto">â</i>
                </button>

                <button id="btn-city-search" class="control-button" type="button" title="æœç´¢åŸå¸‚å¤©æ°”">
                    <i class="icon-search">ğŸ”</i>
                </button>
                
                <button id="btn-refresh" class="control-button" type="button" title="åˆ·æ–°å£çº¸ (R)">
                    <i class="icon-refresh">â†»</i>
                </button>
                <button id="btn-hitokoto-refresh" class="control-button" type="button" title="åˆ·æ–°ä¸€è¨€/å¤©æ°” (Y)">
                    <i class="icon-quote">ğŸ”„</i>
                </button>
                <button id="btn-wallpaper-toggle" class="control-button" type="button" title="åˆ‡æ¢å£çº¸æ˜¾ç¤º (T)">
                    <i class="icon-wallpaper-toggle">ğŸ–¼</i>
                </button>
            </div>
            <button id="toggle-button" class="control-button" aria-label="å±•å¼€åŠŸèƒ½åŒº (K)" type="button" tabindex="0">
                <i class="icon-toggle">â†‘</i>
            </button>
        </div>

        <div id="city-selector-container" role="dialog" aria-modal="true" aria-label="åŸå¸‚é€‰æ‹©å™¨" data-step="province">
            <div class="selector-header">
                <button id="city-back-button" title="è¿”å›çœä»½é€‰æ‹©">â†</button>
                <span id="selector-title">è¯·é€‰æ‹©çœä»½/ç›´è¾–å¸‚</span>
                <button id="city-close-button" class="control-button" title="å…³é—­é€‰æ‹©å™¨">âœ–</button>
            </div>
            <div id="province-list" class="selector-list"></div>
            <div id="city-list" class="selector-list" style="display: none;"></div>
        </div>

        <div id="toast" role="alert" aria-live="assertive" aria-atomic="true" style="opacity: 0; transform: translateY(10px);">æºé€‰æ‹©å·²æ”¶èµ·</div>
    </div>

    <script>
        (function () {
            // DOMå¼•ç”¨ (ä¿æŒä¸å˜)
            const bgBlur = document.getElementById('bg-blur');
            const img = document.getElementById('img');
            const progressContainer = document.getElementById('progress-container');
            const toast = document.getElementById('toast');
            
            const infoWidget = document.getElementById('info-widget');
            const sourceContainer = document.getElementById('source-container');
            const functionContainer = document.getElementById('function-container');

            const clockArea = document.getElementById('clock-area');
            const weatherArea = document.getElementById('weather-area');
            const hitokotoArea = document.getElementById('hitokoto-area');
            const locationText = document.getElementById('location-text');
            const tempText = document.getElementById('temp-text');
            const weatherIcon = document.getElementById('weather-icon');
            const hitokotoContent = document.getElementById('hitokoto-content');
            const hitokotoMeta = document.getElementById('hitokoto-meta');
            const sourceButtons = document.getElementById('source-buttons');

            const toggleButton = document.getElementById('toggle-button');
            const btnRefresh = document.getElementById('btn-refresh');
            const btnHitokotoRefresh = document.getElementById('btn-hitokoto-refresh');
            const btnSourceToggle = document.getElementById('btn-source-toggle');
            const btnWallpaperToggle = document.getElementById('btn-wallpaper-toggle');
            const btnClockToggle = document.getElementById('btn-clock-toggle');
            const btnWeatherToggle = document.getElementById('btn-weather-toggle');
            const btnHitokotoToggle = document.getElementById('btn-hitokoto-toggle');
            const btnCitySearch = document.getElementById('btn-city-search');
            
            const citySelectorContainer = document.getElementById('city-selector-container');
            const provinceList = document.getElementById('province-list');
            const cityList = document.getElementById('city-list');
            const cityCloseButton = document.getElementById('city-close-button');
            const cityBackButton = document.getElementById('city-back-button');
            const selectorTitle = document.getElementById('selector-title');

            // çŠ¶æ€å˜é‡ (ä¿æŒä¸å˜)
            let currentSourceIndex = 0;
            let sourcePanelExpanded = false;
            let hasImageLoadedSuccessfully = false;
            let currentCity = null; 
            let cachedGeo = null;
            let cachedWeather = null;
            let currentProvince = null;

            // å›¾ç‰‡æºé…ç½® (ä¿æŒä¸å˜)
            const sources = [
                { url: 'https://www.onexiaolaji.cn/RandomPicture/api/?key=qq249663924&class=2', label: 'I', color: 'hsl(205,90%,50%)' },
                { url: 'https://www.onexiaolaji.cn/RandomPicture/api/?key=qq249663924&class=4', label: 'II', color: 'hsl(120,75%,42%)' },
                { url: 'https://api.r10086.com/æ¨±é“éšæœºå›¾ç‰‡apiæ¥å£.php?å›¾ç‰‡ç³»åˆ—=æå“ç¾å¥³å›¾ç‰‡', label: 'III', color: 'hsl(330,85%,45%)' },
                { url: 'https://api.r10086.com/æ¨±é“éšæœºå›¾ç‰‡apiæ¥å£.php?å›¾ç‰‡ç³»åˆ—=æ—¥æœ¬COSä¸­å›½COS', label: 'IV', color: 'hsl(40,86%,56%)' },
                { url: 'https://api.r10086.com/æ¨±é“éšæœºå›¾ç‰‡apiæ¥å£.php?å›¾ç‰‡ç³»åˆ—=å°‘å¥³å†™çœŸ5', label: 'V', color: 'hsl(280,70%,53%)' },
                { url: 'https://api.r10086.com/æ¨±é“éšæœºå›¾ç‰‡apiæ¥å£.php?å›¾ç‰‡ç³»åˆ—=å°‘å¥³å†™çœŸ6', label: 'VI', color: 'hsl(15,70%,48%)' },
                { url: 'https://api.lolimi.cn/API/meizi/api.php?type=image', label: 'VII', color: 'hsl(190,80%,55%)' },
                { url: 'https://api.lolimi.cn/API/meinv/api.php?type=image', label: 'VIII', color: 'hsl(280,70%,53%)' }
            ];
            
            /* * æ ¸å¿ƒä¿®æ”¹ 3: åŸå¸‚æ¸…å•ä¼˜åŒ–
             * * æ–¹æ¡ˆï¼šä½¿ç”¨æ›´å®Œæ•´çš„ç¡¬ç¼–ç åŸå¸‚åˆ—è¡¨ï¼Œå¹¶åœ¨æ³¨é‡Šä¸­æŒ‡å‡º API ä¼˜åŒ–æ–¹å‘ã€‚
             * å®Œæ•´çš„åŸå¸‚æ•°æ®åº”é€šè¿‡é«˜å¾·/ç™¾åº¦åœ°å›¾APIæˆ–ä¸“é—¨çš„åœ°ç†æœåŠ¡è·å–ï¼Œä»¥é¿å…å®¢æˆ·ç«¯ç¡¬ç¼–ç ã€‚
             * è¿™é‡Œä½¿ç”¨ä¸€ä¸ªè¾ƒå®Œæ•´çš„ç¡¬ç¼–ç åˆ—è¡¨æ¥æ»¡è¶³å½“å‰éœ€æ±‚ã€‚
             */
            const CN_CITIES_FULL = {
                "åŒ—äº¬": ["åŒ—äº¬"], "ä¸Šæµ·": ["ä¸Šæµ·"], "å¤©æ´¥": ["å¤©æ´¥"], "é‡åº†": ["é‡åº†"],
                "æ²³åŒ—": ["çŸ³å®¶åº„", "å”å±±", "ç§¦çš‡å²›", "é‚¯éƒ¸", "é‚¢å°", "ä¿å®š", "å¼ å®¶å£", "æ‰¿å¾·", "æ²§å·", "å»ŠåŠ", "è¡¡æ°´"],
                "å±±è¥¿": ["å¤ªåŸ", "å¤§åŒ", "é˜³æ³‰", "é•¿æ²»", "æ™‹åŸ", "æœ”å·", "æ™‹ä¸­", "è¿åŸ", "å¿»å·", "ä¸´æ±¾", "å•æ¢"],
                "è¾½å®": ["æ²ˆé˜³", "å¤§è¿", "éå±±", "æŠšé¡º", "æœ¬æºª", "ä¸¹ä¸œ", "é”¦å·", "è¥å£", "é˜œæ–°", "è¾½é˜³", "ç›˜é”¦", "é“å²­", "æœé˜³", "è‘«èŠ¦å²›"],
                "å‰æ—": ["é•¿æ˜¥", "å‰æ—", "å››å¹³", "è¾½æº", "é€šåŒ–", "ç™½å±±", "æ¾åŸ", "ç™½åŸ", "å»¶è¾¹"],
                "é»‘é¾™æ±Ÿ": ["å“ˆå°”æ»¨", "é½é½å“ˆå°”", "é¸¡è¥¿", "é¹¤å²—", "åŒé¸­å±±", "å¤§åº†", "ä¼Šæ˜¥", "ä½³æœ¨æ–¯", "ä¸ƒå°æ²³", "ç‰¡ä¸¹æ±Ÿ", "é»‘æ²³", "ç»¥åŒ–", "å¤§å…´å®‰å²­"],
                "æ±Ÿè‹": ["å—äº¬", "æ— é”¡", "å¾å·", "å¸¸å·", "è‹å·", "å—é€š", "è¿äº‘æ¸¯", "æ·®å®‰", "ç›åŸ", "æ‰¬å·", "é•‡æ±Ÿ", "æ³°å·", "å®¿è¿"],
                "æµ™æ±Ÿ": ["æ­å·", "å®æ³¢", "æ¸©å·", "å˜‰å…´", "æ¹–å·", "ç»å…´", "é‡‘å", "è¡¢å·", "èˆŸå±±", "å°å·", "ä¸½æ°´"],
                "å®‰å¾½": ["åˆè‚¥", "èŠœæ¹–", "èšŒåŸ ", "æ·®å—", "é©¬éå±±", "æ·®åŒ—", "é“œé™µ", "å®‰åº†", "é»„å±±", "æ»å·", "é˜œé˜³", "å®¿å·", "å…­å®‰", "äº³å·", "æ± å·", "å®£åŸ"],
                "ç¦å»º": ["ç¦å·", "å¦é—¨", "è†ç”°", "ä¸‰æ˜", "æ³‰å·", "æ¼³å·", "å—å¹³", "é¾™å²©", "å®å¾·"],
                "æ±Ÿè¥¿": ["å—æ˜Œ", "æ™¯å¾·é•‡", "èä¹¡", "ä¹æ±Ÿ", "æ–°ä½™", "é¹°æ½­", "èµ£å·", "å‰å®‰", "å®œæ˜¥", "æŠšå·", "ä¸Šé¥¶"],
                "å±±ä¸œ": ["æµå—", "é’å²›", "æ·„åš", "æ£åº„", "ä¸œè¥", "çƒŸå°", "æ½åŠ", "æµå®", "æ³°å®‰", "å¨æµ·", "æ—¥ç…§", "ä¸´æ²‚", "å¾·å·", "èŠåŸ", "æ»¨å·", "èæ³½"],
                "æ²³å—": ["éƒ‘å·", "å¼€å°", "æ´›é˜³", "å¹³é¡¶å±±", "å®‰é˜³", "é¹¤å£", "æ–°ä¹¡", "ç„¦ä½œ", "æ¿®é˜³", "è®¸æ˜Œ", "æ¼¯æ²³", "ä¸‰é—¨å³¡", "å—é˜³", "å•†ä¸˜", "ä¿¡é˜³", "å‘¨å£", "é©»é©¬åº—"],
                "æ¹–åŒ—": ["æ­¦æ±‰", "é»„çŸ³", "åå °", "å®œæ˜Œ", "è¥„é˜³", "é„‚å·", "è†é—¨", "å­æ„Ÿ", "è†å·", "é»„å†ˆ", "å’¸å®", "éšå·", "æ©æ–½", "ä»™æ¡ƒ", "æ½œæ±Ÿ", "å¤©é—¨", "ç¥å†œæ¶"],
                "æ¹–å—": ["é•¿æ²™", "æ ªæ´²", "æ¹˜æ½­", "è¡¡é˜³", "é‚µé˜³", "å²³é˜³", "å¸¸å¾·", "å¼ å®¶ç•Œ", "ç›Šé˜³", "éƒ´å·", "æ°¸å·", "æ€€åŒ–", "å¨„åº•", "æ¹˜è¥¿"],
                "å¹¿ä¸œ": ["å¹¿å·", "éŸ¶å…³", "æ·±åœ³", "ç æµ·", "æ±•å¤´", "ä½›å±±", "æ±Ÿé—¨", "æ¹›æ±Ÿ", "èŒ‚å", "è‚‡åº†", "æƒ å·", "æ¢…å·", "æ±•å°¾", "æ²³æº", "é˜³æ±Ÿ", "æ¸…è¿œ", "ä¸œè", "ä¸­å±±", "æ½®å·", "æ­é˜³", "äº‘æµ®"],
                "æµ·å—": ["æµ·å£", "ä¸‰äºš", "ä¸‰æ²™", "å„‹å·", "äº”æŒ‡å±±", "ç¼æµ·", "æ–‡æ˜Œ", "ä¸‡å®", "ä¸œæ–¹"],
                "å››å·": ["æˆéƒ½", "è‡ªè´¡", "æ”€æèŠ±", "æ³¸å·", "å¾·é˜³", "ç»µé˜³", "å¹¿å…ƒ", "é‚å®", "å†…æ±Ÿ", "ä¹å±±", "å—å……", "çœ‰å±±", "å®œå®¾", "å¹¿å®‰", "è¾¾å·", "é›…å®‰", "å·´ä¸­", "èµ„é˜³", "é˜¿å", "ç”˜å­œ", "å‡‰å±±"],
                "è´µå·": ["è´µé˜³", "å…­ç›˜æ°´", "éµä¹‰", "å®‰é¡º", "æ¯•èŠ‚", "é“œä»", "é»”è¥¿å—", "é»”ä¸œå—", "é»”å—"],
                "äº‘å—": ["æ˜†æ˜", "æ›²é–", "ç‰æºª", "ä¿å±±", "æ˜­é€š", "ä¸½æ±Ÿ", "æ™®æ´±", "ä¸´æ²§", "æ¥šé›„", "çº¢æ²³", "æ–‡å±±", "è¥¿åŒç‰ˆçº³", "å¤§ç†", "å¾·å®", "æ€’æ±Ÿ", "è¿ªåº†"],
                "é™•è¥¿": ["è¥¿å®‰", "é“œå·", "å®é¸¡", "å’¸é˜³", "æ¸­å—", "å»¶å®‰", "æ±‰ä¸­", "æ¦†æ—", "å®‰åº·", "å•†æ´›"],
                "ç”˜è‚ƒ": ["å…°å·", "å˜‰å³ªå…³", "é‡‘æ˜Œ", "ç™½é“¶", "å¤©æ°´", "æ­¦å¨", "å¼ æ–", "å¹³å‡‰", "é…’æ³‰", "åº†é˜³", "å®šè¥¿", "é™‡å—", "ä¸´å¤", "ç”˜å—"],
                "é’æµ·": ["è¥¿å®", "æµ·ä¸œ", "æµ·åŒ—", "é»„å—", "æµ·å—", "æœæ´›", "ç‰æ ‘", "æµ·è¥¿"],
                "å®å¤": ["é“¶å·", "çŸ³å˜´å±±", "å´å¿ ", "å›ºåŸ", "ä¸­å«"],
                "æ–°ç–†": ["ä¹Œé²æœ¨é½", "å…‹æ‹‰ç›ä¾", "åé²ç•ª", "å“ˆå¯†", "æ˜Œå‰", "åšå°”å¡”æ‹‰", "å·´éŸ³éƒ­æ¥", "é˜¿å…‹è‹", "å…‹å­œå‹’è‹", "å–€ä»€", "å’Œç”°", "ä¼ŠçŠ", "å¡”åŸ", "é˜¿å‹’æ³°"],
                "å†…è’™å¤": ["å‘¼å’Œæµ©ç‰¹", "åŒ…å¤´", "ä¹Œæµ·", "èµ¤å³°", "é€šè¾½", "é„‚å°”å¤šæ–¯", "å‘¼ä¼¦è´å°”", "å·´å½¦æ·–å°”", "ä¹Œå…°å¯Ÿå¸ƒ", "å…´å®‰", "é”¡æ—éƒ­å‹’", "é˜¿æ‹‰å–„"],
                "è¥¿è—": ["æ‹‰è¨", "æ—¥å–€åˆ™", "æ˜Œéƒ½", "æ—èŠ", "å±±å—", "é‚£æ›²", "é˜¿é‡Œ"],
                "å¹¿è¥¿": ["å—å®", "æŸ³å·", "æ¡‚æ—", "æ¢§å·", "åŒ—æµ·", "é˜²åŸæ¸¯", "é’¦å·", "è´µæ¸¯", "ç‰æ—", "ç™¾è‰²", "è´ºå·", "æ²³æ± ", "æ¥å®¾", "å´‡å·¦"],
                "é¦™æ¸¯": ["é¦™æ¸¯"], "æ¾³é—¨": ["æ¾³é—¨"], "å°æ¹¾": ["å°åŒ—", "é«˜é›„", "å°ä¸­", "å°å—", "æ¡ƒå›­", "æ–°åŒ—", "åŸºéš†", "æ–°ç«¹", "å˜‰ä¹‰"]
            };

            let toastTimeout = null;
            function showToast(msg) { /* ... ä¿æŒä¸å˜ ... */
                toast.textContent = msg;
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
                if (toastTimeout) clearTimeout(toastTimeout);
                toastTimeout = setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(10px)';
                }, 2000);
            }

            /* * æ ¸å¿ƒä¿®æ”¹ 1: æ‹–æ‹½åŠŸèƒ½å®ç° - å–æ¶ˆå¸é™„å±å¹•è¾¹ç¼˜
             * * ç§»é™¤ clampPosition ä¸­çš„å¸é™„é€»è¾‘ï¼Œåªä¿ç•™è¾¹ç•Œé™åˆ¶ï¼Œ
             * ç§»é™¤ onPointerUp ä¸­çš„å¸é™„/å¯¹é½/data-align é€»è¾‘ã€‚
             */
            function clampPosition(x, y, elem) {
                const rect = elem.getBoundingClientRect();
                const width = rect.width;
                const height = rect.height;
                let newX = Math.max(0, x);
                let newY = Math.max(0, y);
                newX = Math.min(newX, window.innerWidth - width);
                newY = Math.min(newY, window.innerHeight - height);
                return [newX, newY];
            }

            function makeDraggable(elem) {
                let dragging = false;
                let offsetX = 0;
                let offsetY = 0;
                let isTouch = false;
                
                elem.style.transitionProperty = 'opacity, max-height, max-width, background, backdrop-filter, box-shadow, transform';
                elem.style.cursor = 'grab';

                function onPointerDown(e) {
                    if (elem.id !== 'info-widget' && e.target.closest('button, input, a, .src-block')) {
                         return; 
                    }
                    if (elem.id === 'info-widget' && e.target.closest('input, button, a')) {
                         return;
                    }
                    
                    isTouch = !!e.touches;
                    if (e.button !== 0 && !isTouch) return;
                    
                    dragging = true;
                    elem.style.cursor = 'grabbing';

                    let clientX = e.clientX ?? (e.touches && e.touches[0].clientX);
                    let clientY = e.clientY ?? (e.touches && e.touches[0].clientY);
                    
                    const rect = elem.getBoundingClientRect();
                    offsetX = clientX - rect.left;
                    offsetY = clientY - rect.top;

                    // å°†å…ƒç´ çš„å®šä½è½¬æ¢ä¸ºç»å¯¹åƒç´ å®šä½
                    elem.style.position = 'fixed';
                    elem.style.left = rect.left + 'px';
                    elem.style.top = rect.top + 'px';
                    elem.style.right = 'unset';
                    elem.style.bottom = 'unset';
                    elem.style.transform = 'none'; 
                    
                    // ç§»é™¤åŠŸèƒ½åŒºçš„ data-align å±æ€§ï¼Œå› ä¸ºå·²ä¸å†éœ€è¦é è¾¹ç•Œå¯¹é½æ¥åˆ¤æ–­å±•å¼€æ–¹å‘
                    if (elem === functionContainer) {
                         elem.removeAttribute('data-align');
                    }


                    if (!isTouch) e.preventDefault(); 
                    e.stopPropagation();
                }

                function onPointerMove(e) {
                    if (!dragging) return;
                    
                    let clientX = e.clientX ?? (e.touches && e.touches[0].clientX);
                    let clientY = e.clientY ?? (e.touches && e.touches[0].clientY);

                    let newX = clientX - offsetX;
                    let newY = clientY - offsetY;

                    requestAnimationFrame(() => {
                        if (dragging) {
                            // ä¿æŒè¾¹ç•Œé™åˆ¶ï¼Œä½†ä¸åšå¸é™„
                            [newX, newY] = clampPosition(newX, newY, elem); 
                            elem.style.left = newX + 'px';
                            elem.style.top = newY + 'px';
                        }
                    });

                    if (isTouch) e.preventDefault();
                    e.stopPropagation();
                }

                function onPointerUp() {
                    if (dragging) {
                        dragging = false;
                        elem.style.cursor = 'grab';
                        isTouch = false;
                        
                        // ç§»é™¤æ‰€æœ‰çš„å¸é™„å’Œå¯¹é½é€»è¾‘
                    }
                }

                elem.style.touchAction = 'none';
                elem.addEventListener('mousedown', onPointerDown);
                elem.addEventListener('touchstart', onPointerDown, { passive: false });
                window.addEventListener('mousemove', onPointerMove);
                window.addEventListener('touchmove', onPointerMove, { passive: false });
                window.addEventListener('mouseup', onPointerUp);
                window.addEventListener('touchend', onPointerUp);
                window.addEventListener('touchcancel', onPointerUp);
            }
            
            // ... (æ—¶é’Ÿã€å¤©æ°”ã€å›¾ç‰‡åˆ·æ–°ã€ä¸€è¨€åŠŸèƒ½ä»£ç ä¿æŒä¸å˜) ...

            // åŸå¸‚é€‰æ‹©é¢æ¿åˆ‡æ¢ï¼ˆå®ç°å®Œå…¨éšè—ï¼‰
            function toggleSourcePanel(expand) {
                if (typeof expand === 'undefined') {
                    sourcePanelExpanded = !sourcePanelExpanded;
                } else {
                    sourcePanelExpanded = expand;
                }
                
                if (sourcePanelExpanded) {
                    sourceContainer.classList.add('expanded');
                    sourceButtons.style.transform = 'translateX(0)';
                    sourceButtons.style.opacity = '1';
                    sourceButtons.style.pointerEvents = 'auto';
                } else {
                    sourceContainer.classList.remove('expanded');
                    sourceButtons.style.transform = 'translateX(100%)';
                    sourceButtons.style.opacity = '0';
                    sourceButtons.style.pointerEvents = 'none';
                }
                
                btnSourceToggle.querySelector('i').textContent = sourcePanelExpanded ? 'âœ–' : 'æº';
                showToast(sourcePanelExpanded ? 'æºé€‰æ‹©å·²å±•å¼€' : 'æºé€‰æ‹©å·²æ”¶èµ·');
            }


            // æ–°çš„åŸå¸‚é€‰æ‹©äº¤äº’é€»è¾‘
            
            // æ­¥éª¤ä¸€ï¼šåŠ è½½çœä»½åˆ—è¡¨ (ä½¿ç”¨ CN_CITIES_FULL)
            function loadProvinces() {
                citySelectorContainer.setAttribute('data-step', 'province');
                selectorTitle.textContent = 'è¯·é€‰æ‹©çœä»½/ç›´è¾–å¸‚';
                provinceList.style.display = 'flex';
                cityList.style.display = 'none';
                provinceList.innerHTML = '';
                
                Object.keys(CN_CITIES_FULL).forEach(province => {
                    const item = document.createElement('div');
                    item.className = 'selector-item';
                    item.textContent = province;
                    item.addEventListener('click', () => loadCities(province));
                    provinceList.appendChild(item);
                });
            }

            // æ­¥éª¤äºŒï¼šåŠ è½½åŸå¸‚åˆ—è¡¨ (ä½¿ç”¨ CN_CITIES_FULL)
            function loadCities(province) {
                currentProvince = province;
                citySelectorContainer.setAttribute('data-step', 'city');
                selectorTitle.textContent = `è¯·é€‰æ‹© ${province} çš„åŸå¸‚`;
                provinceList.style.display = 'none';
                cityList.style.display = 'flex';
                cityList.innerHTML = '';

                const cities = CN_CITIES_FULL[province] || [];
                cities.forEach(city => {
                    const item = document.createElement('div');
                    item.className = 'selector-item';
                    item.textContent = city;
                    item.addEventListener('click', () => selectCity(city));
                    cityList.appendChild(item);
                });
            }

            // æ­¥éª¤ä¸‰ï¼šé€‰æ‹©åŸå¸‚å¹¶è·å–å¤©æ°” (ä¿æŒä¸å˜)
            function selectCity(city) {
                citySelectorContainer.style.display = 'none';
                showToast(`æ­£åœ¨æŸ¥è¯¢ ${city} çš„å¤©æ°”...`);
                fetchWeather(city); // è°ƒç”¨åŸæœ‰çš„ fetchWeather å‡½æ•°
            }
            
            // åŸå¸‚æœç´¢äº‹ä»¶å¤„ç†å™¨ (ä¿æŒä¸å˜)
            function handleCitySearchClick() {
                citySelectorContainer.style.display = 'flex';
                loadProvinces();
            }

            // ç»‘å®šåŸå¸‚é€‰æ‹©å™¨çš„å…³é—­å’Œè¿”å›æŒ‰é’® (ä¿æŒä¸å˜)
            cityCloseButton.addEventListener('click', () => {
                citySelectorContainer.style.display = 'none';
                showToast('åŸå¸‚é€‰æ‹©å·²å–æ¶ˆ');
            });
            
            cityBackButton.addEventListener('click', () => {
                loadProvinces();
                currentProvince = null;
            });

            // å…¶ä»–è¾…åŠ©å‡½æ•°å’Œåˆå§‹åŒ–é€»è¾‘ (ä¿æŒä¸å˜)
            function updateClock() { /* ... ä¿æŒä¸å˜ ... */
                const now = new Date();
                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                const s = String(now.getSeconds()).padStart(2, '0');
                clockArea.textContent = `${h}:${m}:${s}`;
            }

            async function getGeoLocation(cityName = null) { /* ... ä¿æŒä¸å˜ ... */
                locationText.textContent = 'å®šä½ä¸­...';
                if (cityName) {
                    try {
                        const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityName)}&count=1&language=zh&format=json`);
                        if (!response.ok) throw new Error('Failed to fetch city geo');
                        const data = await response.json();
                        if (data.results && data.results.length > 0) {
                            const geo = data.results[0];
                            return { lat: geo.latitude, lon: geo.longitude, name: geo.name || cityName }; 
                        } else {
                            throw new Error('City not found');
                        }
                    } catch (error) {
                        console.error('é€šè¿‡åŸå¸‚åè·å–åœ°ç†ä½ç½®å¤±è´¥:', error);
                        showToast(`æœªæ‰¾åˆ°åŸå¸‚: ${cityName}`);
                        return null; 
                    }
                } else {
                    if (cachedGeo && !currentCity) return cachedGeo;
                    try {
                        const response = await fetch('https://geocoding-api.open-meteo.com/v1/search?name=ip&count=1&language=zh&format=json');
                        if (!response.ok) throw new Error('Failed to fetch IP geo');
                        const data = await response.json();
                        if (data.results && data.results.length > 0) {
                            const geo = data.results[0];
                            const locationName = geo.name || geo.country || 'æœªçŸ¥ä½ç½®';
                            cachedGeo = { lat: geo.latitude, lon: geo.longitude, name: locationName };
                            return cachedGeo;
                        }
                    } catch (error) {
                        console.error('è·å– IP åœ°ç†ä½ç½®å¤±è´¥:', error);
                    }
                }
                return { lat: 0, lon: 0, name: 'ä½ç½®æœªçŸ¥' };
            }

            async function fetchWeather(cityName = null) { /* ... ä¿æŒä¸å˜ ... */
                 // é€»è¾‘ä¿æŒä¸å˜ï¼Œç¡®ä¿è°ƒç”¨ getGeoLocation
                if (!cityName && cachedWeather && !currentCity) return;
                
                if (cityName) {
                    currentCity = cityName;
                    cachedGeo = null; 
                } else if (!currentCity) {
                    currentCity = null; 
                }

                locationText.textContent = cityName ? `${cityName}...` : 'å®šä½ä¸­...';
                tempText.textContent = '--Â°C';
                weatherIcon.textContent = '...';

                const geo = await getGeoLocation(cityName);
                if (!geo || (geo.lat === 0 && geo.lon === 0 && geo.name === 'ä½ç½®æœªçŸ¥')) {
                    if (cityName) currentCity = null; 
                    return;
                }
                
                locationText.textContent = geo.name;

                try {
                    const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${geo.lat}&longitude=${geo.lon}&current=temperature_2m,weather_code&timezone=auto&forecast_days=1`;
                    const response = await fetch(weatherUrl);
                    if (!response.ok) throw new Error('Failed to fetch weather');
                    const data = await response.json();
                    
                    const temp = Math.round(data.current.temperature_2m);
                    const code = data.current.weather_code;
                    const weatherStatus = getWeatherEmoji(code);

                    tempText.textContent = `${temp}Â°C`;
                    weatherIcon.textContent = weatherStatus;
                    cachedWeather = { temp, code, status: weatherStatus };
                    showToast(`${geo.name} å¤©æ°”: ${weatherStatus} ${temp}Â°C`);

                } catch (error) {
                    console.error('è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥:', error);
                    tempText.textContent = 'N/A';
                    weatherIcon.textContent = 'âš ï¸';
                    showToast('è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥');
                }
            }

            function getWeatherEmoji(code) { /* ... ä¿æŒä¸å˜ ... */
                if (code >= 0 && code <= 1) return 'â˜€ï¸'; 
                if (code >= 2 && code <= 3) return 'â˜ï¸'; 
                if (code >= 45 && code <= 48) return 'ğŸŒ«ï¸'; 
                if (code >= 51 && code <= 55) return 'ğŸŒ§ï¸'; 
                if (code >= 61 && code <= 65) return 'ğŸŒ§ï¸'; 
                if (code >= 71 && code <= 75) return 'ğŸŒ¨ï¸'; 
                if (code >= 80 && code <= 82) return 'â›ˆï¸'; 
                if (code >= 85 && code <= 86) return 'â„ï¸'; 
                if (code === 95) return 'â›ˆï¸'; 
                return 'â“';
            }

            function initSourceBlocks() { /* ... ä¿æŒä¸å˜ ... */
                 sourceButtons.innerHTML = '';
                sources.forEach(({ label, color }, i) => {
                    const block = document.createElement('div');
                    block.className = 'src-block';
                    block.style.backgroundColor = color;
                    block.setAttribute('role', 'button');
                    block.setAttribute('tabindex', '0');
                    block.setAttribute('aria-label', 'å›¾ç‰‡æº ' + label);
                    block.textContent = label;
                    block.dataset.index = i;

                    block.addEventListener('click', () => {
                        if (currentSourceIndex !== i) {
                            currentSourceIndex = i;
                            updateSelectedBlock();
                            toggleSourcePanel(false);
                            refreshImage();
                        }
                    });
                    sourceButtons.appendChild(block);
                });
                updateSelectedBlock();
            }

            function updateSelectedBlock() { /* ... ä¿æŒä¸å˜ ... */
                 sourceButtons.querySelectorAll('.src-block').forEach((block, i) => {
                    block.classList.toggle('selected', i === currentSourceIndex);
                });
            }

            async function refreshImage() { /* ... ä¿æŒä¸å˜ ... */
                let url = sources[currentSourceIndex].url;
                let fullUrl = url + (url.includes('?') ? '&' : '?') + '_ts=' + Date.now();

                progressContainer.style.display = 'flex';
                img.style.opacity = '0';
                img.style.display = 'block';
                bgBlur.style.display = 'block';

                const imageLoader = new Image();
                imageLoader.onload = async () => {
                    img.src = fullUrl;
                    bgBlur.src = fullUrl;
                    
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        img.style.opacity = '1';
                        bgBlur.style.opacity = '0.3';
                        hasImageLoadedSuccessfully = true;
                        btnWallpaperToggle.querySelector('i').textContent = 'ğŸ–¼';
                    }, 100);
                };

                imageLoader.onerror = () => {
                    progressContainer.style.display = 'none';
                    img.style.display = 'none';
                    bgBlur.style.opacity = '0';
                    setTimeout(() => bgBlur.style.display = 'none', 300);
                    hasImageLoadedSuccessfully = false;
                    btnWallpaperToggle.querySelector('i').textContent = 'ğŸ–¼';
                    showToast('å£çº¸åŠ è½½å¤±è´¥');
                };

                imageLoader.src = fullUrl;
            }

            async function fetchHitokoto() { /* ... ä¿æŒä¸å˜ ... */
                hitokotoContent.textContent = 'æ­£åœ¨åŠ è½½...';
                hitokotoMeta.textContent = '';
                try {
                    const r = await fetch('https://v1.hitokoto.cn/');
                    const data = await r.json();
                    hitokotoContent.textContent = data.hitokoto;
                    hitokotoMeta.textContent = `â€”â€” ${data.from_who || 'ä½šå'} å‡ºè‡ªã€Š${data.from}ã€‹`;
                } catch {
                    hitokotoContent.textContent = 'è·å–ä¸€è¨€å¤±è´¥ã€‚';
                    hitokotoMeta.textContent = '';
                }
            }
            
            function toggleModule(moduleElement, button, name) { /* ... ä¿æŒä¸å˜ ... */
                const isVisible = moduleElement.style.display !== 'none';
                
                moduleElement.style.display = isVisible ? 'none' : 'block';
                
                button.style.opacity = isVisible ? '0.5' : '1';
                button.title = (isVisible ? 'æ˜¾ç¤º' : 'éšè—') + name;
                showToast(name + (isVisible ? ' å·²éšè—' : ' å·²æ˜¾ç¤º'));
            }

            function toggleFunctionArea() { /* ... ä¿æŒä¸å˜ ... */
                const isCollapsed = functionContainer.classList.toggle('collapsed');
                const icon = isCollapsed ? 'â†‘' : 'â†“';
                toggleButton.querySelector('i').textContent = icon;
                functionContainer.setAttribute('aria-expanded', !isCollapsed);
                showToast(isCollapsed ? 'åŠŸèƒ½åŒºå·²æ”¶èµ·' : 'åŠŸèƒ½åŒºå·²å±•å¼€');
            }

            function toggleWallpaper() { /* ... ä¿æŒä¸å˜ ... */
                if (!hasImageLoadedSuccessfully) {
                    showToast('è¯·å…ˆé€‰æ‹©æºå¹¶åŠ è½½å£çº¸');
                    return;
                }

                const isVisible = img.style.opacity === '1';

                if (isVisible) {
                    img.style.opacity = '0';
                    btnWallpaperToggle.querySelector('i').textContent = 'âœ–';
                    btnWallpaperToggle.title = 'æ˜¾ç¤ºå£çº¸ (T)';
                    showToast('å£çº¸å·²éšè—');
                } else {
                    img.style.opacity = '1';
                    btnWallpaperToggle.querySelector('i').textContent = 'ğŸ–¼';
                    btnWallpaperToggle.title = 'éšè—å£çº¸ (T)';
                    showToast('å£çº¸å·²æ˜¾ç¤º');
                }
            }


            // 6. åˆå§‹åŒ–å’Œäº‹ä»¶ç»‘å®š
            window.addEventListener('DOMContentLoaded', () => {
                initSourceBlocks();
                
                // å¯ç”¨æ‹–æ‹½åŠŸèƒ½ (å·²ä¿®æ”¹)
                makeDraggable(infoWidget); 
                makeDraggable(sourceContainer);
                makeDraggable(functionContainer);
                
                // ç¡®ä¿åŠŸèƒ½åŒºå’Œæºé€‰æ‹©åŒºåœ¨å³ä¸Šè§’çš„åˆå§‹å®šä½æ­£ç¡®
                // ç”±äºå–æ¶ˆäº†å¸é™„ï¼Œä¸å†è®¾ç½® data-alignï¼Œä½¿ç”¨ CSS é»˜è®¤çš„ right å¯¹é½
                
                // åˆå§‹çŠ¶æ€
                functionContainer.classList.add('collapsed');
                toggleButton.querySelector('i').textContent = 'â†‘';
                
                // å¯åŠ¨æ—¶é’Ÿ
                updateClock();
                setInterval(updateClock, 1000);

                // ç»‘å®šäº‹ä»¶
                btnRefresh.addEventListener('click', () => { refreshImage(); showToast('åˆ·æ–°å£çº¸'); });
                
                btnHitokotoRefresh.addEventListener('click', () => { 
                    fetchHitokoto(); 
                    fetchWeather(currentCity); 
                });
                
                btnSourceToggle.addEventListener('click', () => toggleSourcePanel());
                btnWallpaperToggle.addEventListener('click', toggleWallpaper);
                toggleButton.addEventListener('click', toggleFunctionArea);

                // ç‹¬ç«‹å†…å®¹åˆ‡æ¢äº‹ä»¶
                btnClockToggle.addEventListener('click', () => toggleModule(clockArea, btnClockToggle, 'æ—¶é’Ÿ'));
                btnWeatherToggle.addEventListener('click', () => toggleModule(weatherArea, btnWeatherToggle, 'å¤©æ°”'));
                btnHitokotoToggle.addEventListener('click', () => toggleModule(hitokotoArea, btnHitokotoToggle, 'ä¸€è¨€'));

                // æœç´¢åŸå¸‚æŒ‰é’®äº‹ä»¶ (æ–°çš„å¤šæ­¥é€‰æ‹©)
                btnCitySearch.addEventListener('click', handleCitySearchClick);

                // é»˜è®¤åŠ è½½
                fetchHitokoto();
                fetchWeather(); 

                // å¿«æ·é”®ç»‘å®š (æ·»åŠ äº†å¯¹ citySelectorContainer çš„æ£€æŸ¥)
                window.addEventListener('keydown', e => {
                    if (e.isComposing || citySelectorContainer.style.display !== 'none') return; // å¼¹çª—å¼€å¯æ—¶ç¦ç”¨å¿«æ·é”®

                    switch (e.key.toLowerCase()) {
                        case 'r':
                            e.preventDefault();
                            btnRefresh.click();
                            break;
                        case 'y':
                            e.preventDefault();
                            btnHitokotoRefresh.click();
                            break;
                        case 'u':
                            e.preventDefault();
                            btnHitokotoToggle.click();
                            break;
                        case 'h':
                            e.preventDefault();
                            btnSourceToggle.click();
                            break;
                        case 't':
                            e.preventDefault();
                            btnWallpaperToggle.click();
                            break;
                        case 'k':
                            e.preventDefault();
                            toggleButton.click();
                            break;
                    }
                });
            });

        })();
    </script>


</body></html>